<!DOCTYPE html>
<html lang="zh-CN">

  
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <meta name="author" content="è‘£æ²…é‘«, yuanxin.me@gmail.com">
  
  
  
  <title>Kubernetes (K8S) | Shen Peng&#39;s Blog</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="kubernetes,kubernetes,docker,k8s,linux,">
  

  <script>
    console.log('\n%c Hexo-theme-bmw v4.0 ' + '%c ğŸ‰ https://github.com/dongyuanxin/theme-bmw ğŸ‰\n' + '\n%c View demo online ' + '%c ğŸ” https://godbmw.com/ ğŸ”  \n' , 'color: #fadfa3; background: #030307; padding:3px 0;', '', 'color: #fadfa3; background: #030307; padding:3px 0;', '');
  </script>

  

  

  
    <link rel="icon" href="/images/favicon.ico">
    <link rel="apple-touch-icon" href="/images/touch-icon.png">
  

  <link href="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/icon/iconfont.css">
<link rel="stylesheet" href="/css/github-markdown.css">
<link rel="stylesheet" href="/css/highlight.css">

  <script src="/js/util.js"></script>
<script src="/js/valine.min.js"></script>

  

  
    <link href="https://cdn.bootcss.com/aplayer/1.10.1/APlayer.min.css" rel="stylesheet">
    <script src="https://cdn.bootcss.com/aplayer/1.10.1/APlayer.min.js" async></script>
  

  
    <link href="https://cdn.bootcss.com/social-share.js/1.0.16/css/share.min.css" rel="stylesheet">
  
  
  <script src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js" async></script>
  
  
    <script src="//cdn.jsdelivr.net/npm/leancloud-storage@3.11.0/dist/av-min.js"></script>
  

</head>

  <body>

    

    <div id="app">

      <div class="header-wrap">
  <header>
    <div class="site-brand">
      <div class="site-title">
        <a href="/">shenpeng1982.github.io</a>
      </div>
    </div>
    <nav class="site-navigation">
      <ul class="nav-menu">
      
        <li class="nav-item" data-path="/">
          
            <a href="/" target="_self">
              ä¸»é¡µ
            </a>
          
        </li>
      
        <li class="nav-item" data-path="/archives/">
          
            <a href="/archives/" target="_self">
              å½’æ¡£
            </a>
          
        </li>
      
        <li class="nav-item" data-path="/categories/">
          
            <a href="/categories/" target="_self">
              åˆ†ç±»
            </a>
          
        </li>
      
        <li class="nav-item" data-path="/tags/">
          
            <a href="/tags/" target="_self">
              æ ‡ç­¾
            </a>
          
        </li>
      
        <li class="nav-item" data-path="/friends/">
          
            <a href="/friends/" target="_self">
              å‹é“¾
            </a>
          
        </li>
      
        <li class="nav-item" data-path="/about/">
          
            <a href="/about/" target="_self">
              å…³äº
            </a>
          
        </li>
      
        <li class="nav-item" data-path="">
          
            <a href="javascript:void(0);" v-else="">æŠ“åˆ°æˆ‘</a>
            <ul class="nav-menu--dropdown">
              
                <li>
                  <a href="https://github.com/shenpeng1982" target="_blank">
                    Github
                  </a>
                </li>
              
                <li>
                  <a href="https://www.douban.com/people/155688738/statuses" target="_blank">
                    çŸ¥ä¹
                  </a>
                </li>
              
            </ul>
          
        </li>
      
      </ul>
    </nav>
    <i class="iconfont icon-menu"></i>
  </header>
</div>

<script>
  let links = document.querySelectorAll('.nav-item');
  for(let link of links){
    let childrenLink = link.querySelector('ul');
    link.addEventListener('mouseenter', () => {
      if(childrenLink) {
        childrenLink.className = "nav-menu--dropdown active";
      }
    })
    link.addEventListener('mouseleave', () => {
      if(childrenLink) {
        childrenLink.className = "nav-menu--dropdown";
      }
    })
  }
  let rootRealPath = getRealPath(window.location.pathname, true);
  for(let link of links) {
    let linkPath = link.getAttribute("data-path");
    if(linkPath && getRealPath(linkPath, true) === rootRealPath) {
      link.className = "nav-item hover";
    }
  }

  let iconMenu = document.querySelector("i.iconfont.icon-menu"),
    iconMenuClicked = false;
  let navDOM = document.querySelector("nav.site-navigation");
  iconMenu.addEventListener("click", () => {
    iconMenuClicked 
      ? navDOM.className = "site-navigation active"
      : navDOM.className = "site-navigation";
    iconMenuClicked = !iconMenuClicked;
  })
</script>

      








<div class="container post-index">

  

<div class="post">
  <h1 class="article-title">
    <span>Kubernetes (K8S)</span>
  </h1>
  <div class="article-top-meta">
    <span>
      å‘å¸ƒ : 
      2020-02-15
    </span>
    
      <span>
        åˆ†ç±» : 
          <a href="/categories/kubernetes/">
            kubernetes
          </a>
      </span>
    
    
      <span>
        æµè§ˆ : <span class="article-timer" data-identity="Kubernetes-K8S"></span>
      </span>
    
  </div>

  

  <div class="article-content">
    <div class="markdown-body">
      <h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>Kubernetesè¿™ä¸ªè¯æ¥è‡ªå¸Œè…Šè¯­ï¼Œæ„æ€æ˜¯â€œèˆµæ‰‹â€æˆ–â€œé¢†èˆªå‘˜â€ï¼ŒK8Sæ˜¯Kubernetesçš„ç¼©å†™ã€‚</p>
<p>Kubernetesæ˜¯googleçš„å®¹å™¨ç¼–æ’å·¥å…·Borgçš„å¼€æºç‰ˆæœ¬ï¼Œgoogleåœ¨2014å¹´å°†å…¶å¼€æºï¼Œå®é™…ä¸ŠKubernetesä¹Ÿæ˜¯åº”ç”¨å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„å·¥å…·ã€‚</p>
<p>é€šè¿‡Kubernetesï¼Œå¯ä»¥å®ç°å¤§è§„æ¨¡å®¹å™¨é›†ç¾¤çš„çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œè‡ªåŠ¨æ‰©ç¼©å®¹ï¼Œç»´æŠ¤ç­‰ã€‚</p>
<p>Kuberneteså¯ä»¥è¿è¡Œåœ¨ç‰©ç†æœºæˆ–è™šæ‹Ÿæœºä¸Šã€‚</p>
<h2 id="ç‰¹ç‚¹"><a href="#ç‰¹ç‚¹" class="headerlink" title="ç‰¹ç‚¹"></a>ç‰¹ç‚¹</h2><p><strong>å¯ç§»æ¤ï¼š</strong>æ”¯æŒå…¬æœ‰äº‘ï¼Œç§æœ‰äº‘ï¼Œæ··åˆäº‘ï¼Œå¤šé‡äº‘<br><strong>å¯æ‰©å±•ï¼š</strong>æ¨¡å—åŒ–ï¼Œæ’ä»¶åŒ–ï¼Œå¯æŒ‚è½½ï¼Œå¯ç»„åˆ<br><strong>è‡ªåŠ¨åŒ–ï¼š</strong>è‡ªåŠ¨éƒ¨ç½²ï¼Œè‡ªåŠ¨é‡å¯ï¼Œè‡ªåŠ¨å¤åˆ¶ï¼Œè‡ªåŠ¨æ‰©å±•/æ”¶ç¼©</p>
<h2 id="åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†æ­¥éª¤"><a href="#åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†æ­¥éª¤" class="headerlink" title="åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†æ­¥éª¤"></a>åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†æ­¥éª¤</h2><h3 id="åˆ›å»ºé›†ç¾¤"><a href="#åˆ›å»ºé›†ç¾¤" class="headerlink" title="åˆ›å»ºé›†ç¾¤"></a>åˆ›å»ºé›†ç¾¤</h3><p><img src="/2020/02/15/Kubernetes-K8S/./Pict_20200217_001.jpg" alt="Alt text"></p>
<h3 id="éƒ¨ç½²åº”ç”¨"><a href="#éƒ¨ç½²åº”ç”¨" class="headerlink" title="éƒ¨ç½²åº”ç”¨"></a>éƒ¨ç½²åº”ç”¨</h3><p><img src="/2020/02/15/Kubernetes-K8S/./Pict_20200217_002.jpg" alt="Alt text"></p>
<h4 id="DEMO"><a href="#DEMO" class="headerlink" title="DEMO"></a>DEMO</h4><p><a href="https://kubernetes.io/docs/tutorials/kubernetes-basics/deploy-app/deploy-interactive/" target="_blank" rel="noopener">https://kubernetes.io/docs/tutorials/kubernetes-basics/deploy-app/deploy-interactive/</a></p>
<h3 id="æŸ¥çœ‹åº”ç”¨"><a href="#æŸ¥çœ‹åº”ç”¨" class="headerlink" title="æŸ¥çœ‹åº”ç”¨"></a>æŸ¥çœ‹åº”ç”¨</h3><p><img src="/2020/02/15/Kubernetes-K8S/./Pict_20200217_003.jpg" alt="Alt text"></p>
<h3 id="å‘å¸ƒåº”ç”¨"><a href="#å‘å¸ƒåº”ç”¨" class="headerlink" title="å‘å¸ƒåº”ç”¨"></a>å‘å¸ƒåº”ç”¨</h3><p><img src="/2020/02/15/Kubernetes-K8S/./Pict_20200217_004.jpg" alt="Alt text"></p>
<h3 id="æ‰©å±•åº”ç”¨"><a href="#æ‰©å±•åº”ç”¨" class="headerlink" title="æ‰©å±•åº”ç”¨"></a>æ‰©å±•åº”ç”¨</h3><p><img src="/2020/02/15/Kubernetes-K8S/./Pict_20200217_005.jpg" alt="Alt text"></p>
<h3 id="æ›´æ–°åº”ç”¨"><a href="#æ›´æ–°åº”ç”¨" class="headerlink" title="æ›´æ–°åº”ç”¨"></a>æ›´æ–°åº”ç”¨</h3><p><img src="/2020/02/15/Kubernetes-K8S/./Pict_20200217_006.jpg" alt="Alt text"></p>
<h2 id="ä¸ºä»€ä¹ˆä½¿ç”¨å®¹å™¨ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆä½¿ç”¨å®¹å™¨ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆä½¿ç”¨å®¹å™¨ï¼Ÿ"></a>ä¸ºä»€ä¹ˆä½¿ç”¨å®¹å™¨ï¼Ÿ</h2><p><img src="/2020/02/15/Kubernetes-K8S/./Pict_20200215_001.jpg" alt="Alt text"></p>
<p>ä¼ ç»Ÿæ–¹å¼ï¼Œåº”ç”¨çš„è¿è¡Œï¼Œé…ç½®ï¼Œç®¡ç†ï¼Œæ‰€æœ‰çš„ç”Ÿå‘½å‘¨æœŸå’Œæ“ä½œç³»ç»Ÿç»‘å®šï¼Œä½†è¿™æ ·åšä¸åˆ©äºåº”ç”¨çš„å‡çº§ï¼Œå›æ»šç­‰ã€‚<br>å½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡è™šæ‹Ÿæœºæ¥å®ç°ï¼Œä½†è™šæ‹Ÿæœºéå¸¸é‡ã€‚<br>é€šè¿‡å®¹å™¨æ¥éƒ¨ç½²åº”ç”¨ï¼Œå®¹å™¨ä¹‹é—´äº’ç›¸éš”ç¦»ï¼Œå®¹å™¨ä¸åº•å±‚ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿæ˜¯è§£è€¦çš„ï¼Œå ç”¨èµ„æºå°‘ï¼Œéƒ¨ç½²å¿«ï¼Œæ¯ä¸ªåº”ç”¨è¢«æ‰“åŒ…ä¸ºä¸€ä¸ªå®¹å™¨é•œåƒã€‚</p>
<p>å®¹å™¨çš„ä¼˜åŠ¿ï¼š<br><strong>å¿«é€Ÿåˆ›å»º/éƒ¨ç½²åº”ç”¨ï¼š</strong>ä¸è™šæ‹Ÿæœºç›¸æ¯”ï¼Œå®¹å™¨é•œåƒçš„åˆ›å»ºæ›´åŠ å®¹æ˜“ã€‚<br><strong>æŒç»­å¼€å‘ã€é›†æˆå’Œéƒ¨ç½²ï¼š</strong>æä¾›å¯é ï¼Œé¢‘ç¹ï¼Œç®€å•çš„å®¹å™¨é•œåƒåˆ›å»º/éƒ¨ç½²/å›æ»šï¼ˆå®¹å™¨é•œåƒä¸å¯å˜ï¼‰<br><strong>å¼€å‘ä¸è¿è¡Œç›¸åˆ†ç¦»</strong><br><strong>å¼€å‘ï¼Œæµ‹è¯•ä¸ç”Ÿäº§ç¯å¢ƒä¸€è‡´</strong><br><strong>äº‘å¹³å°æˆ–å…¶å®ƒæ“ä½œç³»ç»Ÿï¼š</strong>å®¹å™¨é•œåƒå¯ä»¥åœ¨RHELï¼ŒUbuntuï¼ŒCentOSç­‰å…¶å®ƒä»»ä½•ç¯å¢ƒè¿è¡Œ<br><strong>æ¾è€¦åˆï¼ˆLoosely coupledï¼‰ï¼Œåˆ†å¸ƒå¼ï¼Œå¼¹æ€§ï¼Œå¾®æœåŠ¡åŒ–ï¼š</strong>åº”ç”¨ç¨‹åºåˆ†ä¸ºæ›´å°çš„ã€ç‹¬ç«‹çš„éƒ¨ä»¶<br><strong>èµ„æºéš”ç¦»</strong><br><strong>èµ„æºåˆ©ç”¨ï¼š</strong>æ›´é«˜æ•ˆ</p>
<h2 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><h3 id="Cluster"><a href="#Cluster" class="headerlink" title="Cluster"></a>Cluster</h3><p>Clusterï¼ˆé›†ç¾¤ï¼‰æ˜¯è®¡ç®—ã€å­˜å‚¨å’Œç½‘ç»œèµ„æºçš„é›†åˆã€‚<br>æœ€ç®€å•çš„clusterå¯ä»¥åªæœ‰ä¸€å°ä¸»æœºï¼Œå³æ˜¯masterä¹Ÿæ˜¯nodeã€‚</p>
<h3 id="Master"><a href="#Master" class="headerlink" title="Master"></a>Master</h3><p>Masteræ˜¯Clusterçš„å¤§è„‘ï¼Œä¸»è¦è´Ÿè´£è°ƒåº¦ï¼Œå³å†³å®šåº”ç”¨æ”¾åœ¨å“ªé‡Œè¿è¡Œã€‚<br>masterå¯ä»¥æ˜¯ç‰©ç†æœºæˆ–è™šæ‹Ÿæœºã€‚</p>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>ä¸ºäº†é«˜å¯ç”¨ï¼Œå¯ä»¥æœ‰å¤šä¸ªmaster</li>
</ul>
</blockquote>
<h3 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h3><p>Nodeçš„èŒè´£æ˜¯è¿è¡Œå®¹å™¨åº”ç”¨ï¼Œnodeç”±masterç®¡ç†ï¼Œnodeè´Ÿè´£ç›‘æ§å¹¶æ±‡æŠ¥å®¹å™¨çš„çŠ¶æ€ï¼Œå¹¶æ ¹æ®masterçš„è¦æ±‚ç®¡ç†å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸã€‚<br>nodeå¯ä»¥æ˜¯ç‰©ç†æœºæˆ–è™šæ‹Ÿæœºã€‚</p>
<h3 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h3><p>Namespaceå¯ä»¥å°†ä¸€ä¸ªç‰©ç†çš„clusteråˆ’åˆ†ä¸ºå¤šä¸ªé€»è¾‘çš„clusterï¼Œæ¯ä¸ªé€»è¾‘çš„clusterå°±æ˜¯ä¸€ä¸ªnamespaceã€‚<br>ä¸åŒçš„namespaceé‡Œçš„èµ„æºæ˜¯å®Œå…¨éš”ç¦»çš„ã€‚<br>Kubernetesé»˜è®¤åˆ›å»ºäº†ä¸¤ä¸ªnamespaceï¼š</p>
<ul>
<li>defaultï¼šåˆ›å»ºèµ„æºæ—¶å¦‚æœä¸æŒ‡å®šnamespaceï¼Œé»˜è®¤æ”¾åœ¨è¿™é‡Œ</li>
<li>kube-systemï¼šK8Sç³»ç»Ÿè‡ªå·±åˆ›å»ºçš„èµ„æºï¼Œæ”¾åœ¨è¿™é‡Œã€‚</li>
</ul>
<h3 id="Pod-å¾®æœåŠ¡"><a href="#Pod-å¾®æœåŠ¡" class="headerlink" title="Pod (å¾®æœåŠ¡)"></a>Pod (å¾®æœåŠ¡)</h3><p>podæ˜¯ä¸€ä¸ªé€»è¾‘æ¦‚å¿µï¼Œpodæ˜¯Kubernetesä¸­å¯åˆ›å»º/éƒ¨ç½²çš„æœ€å°å•ä½ï¼ˆpodæ˜¯kubernetesçš„åŸå­è°ƒåº¦å•ä½ï¼Œå› æ­¤ä¸€ä¸ªpodä¸­çš„å®¹å™¨éƒ½åº”è¯¥åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼‰ï¼Œæ¯ä¸ªpodæ˜¯åº”ç”¨çš„ä¸€ä¸ªå®ä¾‹</p>
<p>ä¸€ä¸ªPodå°è£…äº†å¦‚ä¸‹å†…å®¹ï¼š</p>
<ul>
<li>ä¸€ä¸ªåº”ç”¨å®¹å™¨ï¼ˆä¹Ÿå¯ä»¥æœ‰å¤šä¸ªå®¹å™¨ï¼‰</li>
<li>å­˜å‚¨èµ„æº</li>
<li>ç‹¬ç«‹çš„ç½‘ç»œIP</li>
<li>ç®¡ç†æ§åˆ¶å®¹å™¨è¿è¡Œæ–¹å¼çš„ç­–ç•¥é€‰é¡¹</li>
</ul>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>å®¹å™¨çš„æœ¬è´¨æ˜¯è¿›ç¨‹</li>
<li>podç±»ä¼¼äºè¿›ç¨‹ç»„</li>
</ul>
</blockquote>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>dockeræ˜¯podä¸­çš„å¸¸è§è¿è¡Œæ—¶(runtime)ï¼Œpodä¹Ÿæ”¯æŒå…¶ä»–çš„è¿è¡Œæ—¶</li>
<li>åœ¨å•ä¸ªpodä¸­ç®¡ç†å¤šä¸ªå®¹å™¨æ˜¯ç›¸å¯¹é«˜çº§çš„ç”¨æ³•</li>
</ul>
</blockquote>
<p>Podæä¾›ä¸¤ç§å…±äº«èµ„æºï¼šç½‘ç»œï¼Œå­˜å‚¨</p>
<p><strong>ç½‘ç»œï¼š</strong></p>
<ul>
<li>æ¯ä¸ªpodåˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„IP</li>
<li>Podä¸­çš„æ¯ä¸ªå®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´ï¼ˆnamespaceï¼‰ï¼ŒåŒ…æ‹¬IPå’Œç«¯å£</li>
<li>Podå†…çš„å®¹å™¨å¯ä»¥ä½¿ç”¨localhostäº’ç›¸é€šä¿¡</li>
</ul>
<p><strong>å­˜å‚¨ï¼š</strong></p>
<ul>
<li>Podå†…æ‰€æœ‰çš„å®¹å™¨å¯ä»¥è®¿é—®å…±äº«å­˜å‚¨ï¼ˆshared volumesï¼‰</li>
<li>volumesè¿˜ç”¨äºPodä¸­çš„æ•°æ®æŒä¹…åŒ–</li>
</ul>
<p>ä¸¾ä¾‹ï¼Œå¦‚ä¸‹å›¾è¿™ä¸ªpodåŒ…å«File Pullerï¼ŒWeb Serverä¸¤ä¸ªå®¹å™¨ï¼Œå…±äº«ä¸€ä¸ªå­˜å‚¨volume<br><img src="/2020/02/15/Kubernetes-K8S/./Pict_20200223_001.jpg" alt="Alt text"></p>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>é‡å¯podå’Œé‡å¯å®¹å™¨ä¸æ˜¯ä¸€å›äº‹ï¼Œpodåªæä¾›å®¹å™¨çš„è¿è¡Œç¯å¢ƒå¹¶ä¿æŒå®¹å™¨çš„è¿è¡ŒçŠ¶æ€ï¼Œå®¹å™¨é‡å¯å¹¶ä¸ä¼šå¯¼è‡´podçš„é‡å¯</li>
</ul>
</blockquote>
<p>ä¸Šé¢è¯´åˆ°podæ˜¯ä¸€ä¸ªé€»è¾‘æ¦‚å¿µï¼Œpodå®é™…ä¸Šæ˜¯å…±äº«äº†èµ„æºçš„ä¸€ç»„å®¹å™¨ï¼Œä¸»è¦æ˜¯å…±äº«äº†ç½‘ç»œå’Œå­˜å‚¨ã€‚<br>podåœ¨k8sä¸­çš„å®ç°éœ€è¦æœ‰ä¸€ä¸ªä¸­é—´å®¹å™¨ï¼Œå«åš<code>infra</code>å®¹å™¨ï¼Œ<code>infra</code>å®¹å™¨æ°¸è¿œè¢«ç¬¬ä¸€ä¸ªåˆ›å»ºï¼Œç„¶åå…¶ä»–å®¹å™¨å’Œ<code>infra</code>å®¹å™¨å…³è”åœ¨ä¸€èµ·ã€‚</p>
<p><code>Infra</code>å®¹å™¨ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„é•œåƒ<code>k8s.gcr.io/pause</code>ï¼Œ<code>pause</code>é•œåƒç”±æ±‡ç¼–ç¼–å†™ï¼Œ<code>Infra</code>å®¹å™¨æ°¸è¿œå¤„äºæš‚åœçŠ¶æ€ã€‚</p>
<p>podçš„ç”Ÿå‘½å‘¨æœŸå’Œ<code>Infra</code>å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸä¸€è‡´ï¼Œå› æ­¤é‡å¯podå’Œé‡å¯å®¹å™¨ä¸æ˜¯ä¸€å›äº‹ã€‚</p>
<p><img src="/2020/02/15/Kubernetes-K8S/./Image-020.jpg" alt="Alt text"></p>
<p>ä¸Šå›¾ä¸ºk8sä¸­çš„pauseé•œåƒ</p>
<p>åˆ›å»ºä¸€ä¸ªpodçš„yamlé…ç½®æ–‡ä»¶ï¼Œå¦‚ä¸‹</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      image:</span> <span class="attr">nginx:latest</span></span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">      - containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥åˆ©ç”¨yamlè¯­æ³•å·¥å…·ï¼Œå¦‚ <a href="https://www.bejson.com/validators/yaml/" target="_blank" rel="noopener">Link</a>ï¼Œç”¨ä»¥ä¿è¯ç”Ÿæˆçš„yamlæ–‡ä»¶æ ¼å¼æ­£ç¡®</p>
<p>æ ¡éªŒé€šè¿‡ï¼Œæ ¼å¼æ­£ç¡®<br><img src="/2020/02/15/Kubernetes-K8S/./Image-021.jpg" alt="Alt text"></p>
<p>æ ¡éªŒæœªé€šè¿‡ï¼Œspecçš„å€¼æœ‰é—®é¢˜ï¼Œä¸èƒ½å‡ºç°<code>null</code><br><img src="/2020/02/15/Kubernetes-K8S/./Image-022.jpg" alt="Alt text"></p>
<p>åˆ›å»ºpod</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f pod_nginx.yaml</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>å»ºè®®åœ¨æ¯ä¸ªèŠ‚ç‚¹å°†é•œåƒæ‹‰åˆ°æœ¬åœ°ï¼Œå¦åˆ™æ¯æ¬¡åˆ›å»ºpodæ—¶æ‰¾ä¸åˆ°æœ¬åœ°é•œåƒéƒ½ä¼šå°è¯•è¿çº¿ä¸‹è½½</li>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼ŒmasterèŠ‚ç‚¹ä¸ä¼šå‚ä¸podçš„éƒ¨ç½²</li>
</ul>
</blockquote>
<p>æŸ¥çœ‹podçš„çŠ¶æ€</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@ol75k8sn2 ~]# kubectl get pods</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx   1/1     Running   0          18m</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹podçš„æ›´å¤šçš„çŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬IPï¼Œnodeç­‰ï¼›å¦‚ä¸‹IPï¼š192.168.43.70æ˜¯K8Så†…éƒ¨ç½‘ç»œIPï¼Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½å¯ä»¥pingé€šï¼ŒIPçš„å–å€¼èŒƒå›´ç”±åˆå§‹åŒ–masterèŠ‚ç‚¹æ—¶<code>kubeadm init</code>çš„<code>--pod-network-cidr</code>å‚æ•°æ¥å®šä¹‰</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@ol75k8sn2 ~]# kubectl get pods -o wide</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE   IP              NODE        NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx   1/1     Running   0          17m   192.168.43.70   ol75k8sn2   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p>è·å¾—podçš„è¯¦ç»†ä¿¡æ¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe pods nginx</span><br></pre></td></tr></table></figure>
<p>æœ€åé€šè¿‡curlæµ‹è¯•ä¸€ä¸‹nginxçš„æ˜¯å¦è¿è¡Œ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@ol75k8sn2 ~]# curl 192.168.43.70</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p><strong>ç°åœ¨åœ¨K8Sçš„èŠ‚ç‚¹ä¸Šå¯ä»¥è®¿é—®å†…éƒ¨ç½‘ç»œçš„podç½‘æ®µ192.168.43.*ï¼Œä½†å¤–éƒ¨è¿˜ä¸å¯ä»¥</strong></p>
<p>åˆ é™¤pod</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ol75k8sn2 ~]# kubectl delete pod nginx</span><br><span class="line">pod &quot;nginx&quot; deleted</span><br></pre></td></tr></table></figure>
<p>æˆ–</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ol75k8sn1 ~]# kubectl delete -f pod_nginx.yml </span><br><span class="line">pod &quot;nginx&quot; deleted</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>podä¸€èˆ¬ä¸ä¼šç›´æ¥ä½¿ç”¨ï¼Œè€Œæ˜¯é€šè¿‡deploymentæ¥ç®¡ç†ä½¿ç”¨</li>
</ul>
</blockquote>
<h3 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h3><p>Kuberneteså¯ä»¥é€šè¿‡controlleråˆ›å»ºå’Œç®¡ç†podï¼Œæä¾›å‰¯æœ¬ç®¡ç†ã€æ»šåŠ¨å‡çº§ã€é›†ç¾¤çº§åˆ«çš„è‡ªæ„ˆèƒ½åŠ›ã€‚ç®€å•çš„è¯´å°±æ˜¯ï¼Œæœ‰å‡ ä¸ªå‰¯æœ¬ï¼Œåœ¨ä»€ä¹ˆæ ·çš„nodeä¸Šè¿è¡Œã€‚</p>
<p>podçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼šå½“podè¢«åˆ›å»ºåï¼Œä¼šè¢«kubernetesè°ƒåº¦åˆ°nodeä¸Šï¼Œç›´åˆ°podçš„è¿›ç¨‹ç»ˆæ­¢ã€è¢«åˆ é™¤ã€å› ä¸ºç¼ºå°‘èµ„æºè¢«é©±é€ã€nodeå‡ºç°æ•…éšœ</p>
<p><strong>Podæ¨¡æ¿ï¼š</strong><br>æ§åˆ¶å™¨ï¼ˆcontrollerï¼‰é€šè¿‡æ¨¡æ¿æ¥åˆ›å»ºpodï¼Œå¯¹æ¨¡æ¿çš„ä¿®æ”¹ä¸ä¼šå½±å“å·²åˆ›å»ºçš„pod</p>
<p>æ ¹æ®ä½œç”¨çš„ä¸åŒï¼Œæœ‰å¤šç§controller</p>
<h4 id="ReplicaSet"><a href="#ReplicaSet" class="headerlink" title="ReplicaSet"></a>ReplicaSet</h4><p>ç”¨æ¥å®ç°podçš„å¤šå‰¯æœ¬ç®¡ç†ï¼Œæ¥å®ç°podçš„é«˜å¯ç”¨ã€‚å› æ­¤å³ä½¿åªæœ‰ä¸€ä¸ªpodå‰¯æœ¬ï¼Œä¹Ÿåº”è¯¥ç”¨replicasetæ¥ç®¡ç†ã€‚æ¯”å¦‚podæŒ‚äº†ï¼Œè‡ªåŠ¨åœ¨åˆé€‚çš„èŠ‚ç‚¹ä¸Šå¯åŠ¨ä¸€ä¸ªpodã€‚podå‰¯æœ¬çš„æ•°é‡ä¸å¤Ÿäº†ï¼Œè‡ªåŠ¨å¢åŠ ä¸€ä¸ªpodã€‚</p>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>ä¸Šä¸€ä»£çš„ReplicationControllerå·²ç»ä¸æ¨èä½¿ç”¨</li>
<li>ReplicaSetåŒ…å«ReplicationControllerçš„æ‰€æœ‰åŠŸèƒ½ï¼Œä¸»è¦åŒºåˆ«æ˜¯ï¼š</li>
</ul>
<ol>
<li>ReplicationControlleråªæ”¯æŒåŸºäºç­‰å¼çš„é€‰æ‹©å™¨(selector)ï¼Œä¾‹å¦‚selectorï¼ˆenv=devæˆ–environment!=qaï¼‰</li>
<li>ReplicaSetè¿˜æ”¯æŒåŸºäºé›†åˆçš„é€‰æ‹©å™¨(selector)ï¼Œä¾‹å¦‚selectorï¼ˆversion in (v1.0, v2.0)ï¼‰</li>
</ol>
</blockquote>
<p>å¦‚ä¸‹åˆ›å»ºä¸€ä¸ªreplicasetçš„yamlé…ç½®æ–‡ä»¶replicaset_nginx.yml<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure></p>
<p>åˆ›å»ºreplicaset</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f replicaset_nginx.yml</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹åˆ›å»ºçš„replicaset<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ol75k8sn1 ~]# kubectl get rs</span><br><span class="line">NAME    DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx   3         3         3       13m</span><br><span class="line">[root@ol75k8sn1 ~]# kubectl get rs -o wide</span><br><span class="line">NAME    DESIRED   CURRENT   READY   AGE   CONTAINERS   IMAGES   SELECTOR</span><br><span class="line">nginx   3         3         3       13m   nginx        nginx    tier=frontend</span><br></pre></td></tr></table></figure></p>
<p>æŸ¥çœ‹pods</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ol75k8sn1 ~]# kubectl get pods -o wide</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE   IP                NODE        NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-9726z   1/1     Running   0          16m   192.168.125.193   ol75k8sn3   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-984tc   1/1     Running   0          16m   192.168.43.72     ol75k8sn2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-dpql6   1/1     Running   0          16m   192.168.43.71     ol75k8sn2   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p>åˆ é™¤ä¸€ä¸ªpod<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ol75k8sn1 ~]# kubectl delete pod nginx-984tc</span><br><span class="line">pod &quot;nginx-984tc&quot; deleted</span><br></pre></td></tr></table></figure></p>
<p>å†æ¬¡æŸ¥çœ‹ï¼Œå‘ç°ç«‹é©¬åˆæ–°å»ºäº†ä¸€ä¸ªpod<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ol75k8sn1 ~]# kubectl get pods -o wide</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE   IP                NODE        NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-9726z   1/1     Running   0          19m   192.168.125.193   ol75k8sn3   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-dpql6   1/1     Running   0          19m   192.168.43.71     ol75k8sn2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-szxjk   1/1     Running   0          15s   192.168.125.194   ol75k8sn3   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<p>æ”¶ç¼©replicaset</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@ol75k8sn1 ~]# kubectl scale rs nginx --replicas=2</span><br><span class="line">replicaset.apps/nginx scaled</span><br><span class="line">[root@ol75k8sn1 ~]# kubectl get pods -o wide</span><br><span class="line">NAME          READY   STATUS        RESTARTS   AGE    IP                NODE        NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-9726z   1/1     Running       0          25m    192.168.125.193   ol75k8sn3   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-dpql6   1/1     Running       0          25m    192.168.43.71     ol75k8sn2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-szxjk   0/1     Terminating   0          6m4s   &lt;none&gt;            ol75k8sn3   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">[root@ol75k8sn1 ~]# kubectl get pods -o wide</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE   IP                NODE        NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-9726z   1/1     Running   0          25m   192.168.125.193   ol75k8sn3   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-dpql6   1/1     Running   0          25m   192.168.43.71     ol75k8sn2   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p>æ‰©å¼ replicaset</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@ol75k8sn1 ~]# kubectl scale rs nginx --replicas=4</span><br><span class="line">replicaset.apps/nginx scaled</span><br><span class="line">[root@ol75k8sn1 ~]# kubectl get pods -o wide</span><br><span class="line">NAME          READY   STATUS              RESTARTS   AGE   IP                NODE        NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-6vvj7   0/1     ContainerCreating   0          2s    &lt;none&gt;            ol75k8sn3   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-8p66z   0/1     ContainerCreating   0          2s    &lt;none&gt;            ol75k8sn2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-9726z   1/1     Running             0          26m   192.168.125.193   ol75k8sn3   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-dpql6   1/1     Running             0          26m   192.168.43.71     ol75k8sn2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">[root@ol75k8sn1 ~]# kubectl get pods -o wide</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE   IP                NODE        NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-6vvj7   1/1     Running   0          7s    192.168.125.195   ol75k8sn3   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-8p66z   1/1     Running   0          7s    192.168.43.73     ol75k8sn2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-9726z   1/1     Running   0          26m   192.168.125.193   ol75k8sn3   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-dpql6   1/1     Running   0          26m   192.168.43.71     ol75k8sn2   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>replicasetä¸€èˆ¬ä¹Ÿä¸ä¼šç›´æ¥ä½¿ç”¨ï¼Œè€Œæ˜¯é€šè¿‡deploymentæ¥ç®¡ç†ä½¿ç”¨</li>
<li>é€šè¿‡æ”¹å˜replicasetæ¨¡æ¿é‡Œé¢podçš„é•œåƒç‰ˆæœ¬ï¼Œå¯ä»¥å®ç°æ»šåŠ¨å‡çº§</li>
</ul>
</blockquote>
<h4 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h4><p>æœ€å¸¸ç”¨çš„controllerï¼Œç”¨æ¥éƒ¨ç½²podï¼Œç®¡ç†podçš„å‰¯æœ¬ä¹Ÿå°±æ˜¯ç®¡ç†replicasetã€‚</p>
<p>å®˜æ–¹æ–‡æ¡£ <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="noopener">Link</a></p>
<p><img src="/2020/02/15/Kubernetes-K8S/./deployment.png" alt="Alt text"></p>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>å½“ç”¨deploymentæ¥ç®¡ç†replicasetçš„æ—¶å€™ï¼Œå°±ä¸è¦å†æ‰‹åŠ¨ç®¡ç†replicaset</li>
</ul>
</blockquote>
<p>å¦‚ä¸‹ä¸€ä¸ªdeploymentçš„é…ç½®æ–‡ä»¶çš„ä¾‹å­<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">        image:</span> <span class="attr">nginx:v1.17.10</span></span><br><span class="line"><span class="attr">        ports:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure></p>
<p>åˆ›å»ºdeployment<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ol75k8sn1 ~]# kubectl create -f deployment_nginx.yml </span><br><span class="line">deployment.apps/nginx-deployment created</span><br></pre></td></tr></table></figure></p>
<p>æ‰©å±•<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale deployment nginx-deployment --replicas=4</span><br></pre></td></tr></table></figure></p>
<p>ç”¨serviceå°†deploymentæš´éœ²ç»™å¤–ç½‘è®¿é—®ï¼Œå…·ä½“è§serviceç« èŠ‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl expose deployment nginx-deployment --type=NodePort --port=80 --target-port=80</span><br></pre></td></tr></table></figure></p>
<h4 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h4><p>æ¯ä¸ªnodeæœ€å¤šåªèƒ½è¿è¡Œä¸€ä¸ªpodå‰¯æœ¬ã€‚</p>
<h4 id="StatefulSet"><a href="#StatefulSet" class="headerlink" title="StatefulSet"></a>StatefulSet</h4><p>ç”¨äºä¿è¯podçš„æ¯ä¸ªå‰¯æœ¬åœ¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­åç§°æ˜¯ä¸å˜çš„ï¼Œè€Œå…¶ä»–controllerä¸æä¾›è¿™ä¸ªåŠŸèƒ½ã€‚</p>
<h4 id="Job"><a href="#Job" class="headerlink" title="Job"></a>Job</h4><p>ç”¨äºç»“æŸåå°±åˆ é™¤çš„podã€‚</p>
<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>podå¯ä»¥æœ‰å¤šä¸ªå‰¯æœ¬ï¼Œæ¯ä¸ªpodéƒ½æœ‰è‡ªå·±çš„IPï¼Œè€Œpodä¼šé¢‘ç¹çš„è¢«é”€æ¯æˆ–åˆ›å»ºï¼ŒIPä¼šå‘ç”Ÿå˜åŒ–ï¼Œç”¨IPæ¥è®¿é—®podä¸ç°å®ã€‚<br>Serviceå®šä¹‰äº†å¤–ç•Œè®¿é—®ä¸€ç»„ç‰¹å®šçš„podçš„æ–¹å¼ï¼Œserviceæœ‰è‡ªå·±çš„IPå’Œç«¯å£ï¼Œä¸ç®¡podæ€ä¹ˆå˜ï¼Œserviceçš„IPå’Œç«¯å£ä¸å˜ï¼ŒServiceä¸ºpodæä¾›äº†è´Ÿè½½å‡è¡¡ã€‚</p>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>å’ŒOracleçš„Serviceçš„æ¦‚å¿µæœ‰äº›ç±»ä¼¼</li>
</ul>
</blockquote>
<p>serviceæœ‰ClusterIPã€NodePortã€LoadBalancerå‡ ç§ç±»å‹</p>
<h4 id="ClusterIP"><a href="#ClusterIP" class="headerlink" title="ClusterIP"></a>ClusterIP</h4><p>é€šè¿‡<code>kubectl expose</code>ä¸º<code>nginx-deployment</code>è¿™ä¸ªdeploymentåˆ›å»º<code>ClusterIP</code>ç±»å‹çš„service<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ol75k8sn1 ~]# kubectl expose deployment nginx-deployment</span><br><span class="line">service/nginx-deployment exposed</span><br><span class="line">[root@ol75k8sn1 ~]# kubectl get svc </span><br><span class="line">NAME               TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">kubernetes         ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP   28d</span><br><span class="line">nginx-deployment   ClusterIP   10.101.174.40   &lt;none&gt;        80/TCP    12s</span><br></pre></td></tr></table></figure></p>
<p>ç”Ÿæˆçš„serviceçš„IPæ˜¯10.101.174.40ï¼Œä½†è¿™ä¸ªIPåªèƒ½ç”¨äºK8Sé›†ç¾¤å†…éƒ¨è®¿é—®ï¼Œä¹Ÿæ— æ³•pingçš„é€š</p>
<h4 id="NodePort"><a href="#NodePort" class="headerlink" title="NodePort"></a>NodePort</h4><p>é€šè¿‡<code>kubectl expose</code>ä¸º<code>nginx-deployment</code>è¿™ä¸ªdeploymentåˆ›å»º<code>NodePort</code>ç±»å‹çš„service<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl expose deployment nginx-deployment --type=NodePort --port=80 --target-port=80</span><br></pre></td></tr></table></figure></p>
<p><code>--type=NodePort</code>æŒ‡å‡ºåˆ›å»ºçš„serviceç±»å‹æ˜¯<code>NodePort</code><br><code>--port=80</code>æ˜¯serviceå¯¹å¤–æš´éœ²çš„ç«¯å£<br><code>--target-port=80</code>æ˜¯deploymentçš„ç«¯å£</p>
<p>K8Sè‡ªåŠ¨å°†æœ¬æœºï¼ˆæˆ–è€…è¯´æœ¬èŠ‚ç‚¹ï¼‰çš„32291ç«¯å£ï¼Œæ˜ å°„åˆ°serviceçš„80ç«¯å£ï¼›ç«¯å£çš„èŒƒå›´åœ¨<code>30000</code>åˆ°<code>32767</code>ä¹‹é—´<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@ol75k8sn1 ~]# kubectl get svc </span><br><span class="line">NAME               TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">kubernetes         ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP        28d</span><br><span class="line">nginx-deployment   NodePort    10.99.119.252   &lt;none&gt;        80:32291/TCP   3s</span><br></pre></td></tr></table></figure></p>
<p>ä¹‹åå°±å¯ä»¥ç”¨ä»»æ„K8SèŠ‚ç‚¹IPåŠ ç«¯å£æ¥è®¿é—®pod</p>
<p>å¦‚ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\1&gt;curl 192.168.1.81:32291</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<h4 id="LoadBalancer"><a href="#LoadBalancer" class="headerlink" title="LoadBalancer"></a>LoadBalancer</h4><p>é€šè¿‡<code>kubectl expose</code>ä¸º<code>nginx-deployment</code>è¿™ä¸ªdeploymentåˆ›å»º<code>LoadBalancer</code>ç±»å‹çš„service<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl expose deployment nginx-deployment --type=LoadBalancer --port=80 --target-port=80</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>LoadBalanceæ–¹å¼åªèƒ½ç”¨äºäº‘K8Sï¼ˆå¦‚googleçš„GCEï¼Œäºšé©¬é€Šçš„AWSï¼Œé˜¿é‡Œäº‘ç­‰ï¼‰ï¼Œç§æœ‰K8Sæ— æ³•ä½¿ç”¨ï¼Œåœ¨ç§æœ‰K8Sä¸­åˆ›å»ºLoadBalanceç±»å‹çš„serviceï¼Œå…¶<code>EXTERNAL-IP</code>çŠ¶æ€ä¼šä¸€ç›´æ˜¯<code>pending</code> ï¼Œä¹Ÿå°±æ˜¯æç¤ºä½ ä¸€ç›´è·å–ä¸åˆ°<code>EXTERNAL-IP</code></li>
<li>äº‘æœåŠ¡å•†ä¼šç»™LoadBalancerç±»å‹çš„serviceè‡ªåŠ¨åˆ†é…ä¸€ä¸ªå…¬ç½‘IPï¼Œå¹¶å¸®ä½ åšè´Ÿè½½å‡è¡¡</li>
</ul>
</blockquote>
<p>å¦‚ä¸‹æ˜¯åœ¨ç§æœ‰K8Sä¸Šå‡ºé”™ä¿¡æ¯<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ol75k8sn1 ~]# kubectl expose deployment nginx-deployment --type=LoadBalancer --port=80 --target-port=80</span><br><span class="line">service/nginx-deployment exposed</span><br><span class="line">[root@ol75k8sn1 ~]# kubectl get svc </span><br><span class="line">NAME               TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">kubernetes         ClusterIP      10.96.0.1        &lt;none&gt;        443/TCP        28d</span><br><span class="line">nginx-deployment   LoadBalancer   10.102.236.210   &lt;pending&gt;     80:32338/TCP   25s</span><br></pre></td></tr></table></figure></p>
<h4 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h4><p><img src="/2020/02/15/Kubernetes-K8S/./Pict_20200525_001.jpg" alt="Alt text"></p>
<h2 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h2><p><img src="/2020/02/15/Kubernetes-K8S/./1585907988406.png" alt="Alt text"></p>
<p><img src="/2020/02/15/Kubernetes-K8S/./1514877224307415.png" alt="Alt text"></p>
<h3 id="Master-Node"><a href="#Master-Node" class="headerlink" title="Master Node"></a>Master Node</h3><p><strong>etcd:</strong>ä¿å­˜æ•´ä¸ªé›†ç¾¤çš„çŠ¶æ€</p>
<p><strong>API server:</strong>APIæ¥å£ï¼Œæä¾›äº†æ“ä½œèµ„æºçš„å”¯ä¸€æ¥å£ï¼›<br>åŒ…æ‹¬ï¼š</p>
<ul>
<li>æˆæƒ</li>
<li>è®¤è¯</li>
<li>è®¿é—®æ§åˆ¶</li>
<li>APIæ³¨å†Œå’Œå‘ç°ç­‰</li>
</ul>
<p><strong>Control Manager:</strong>ç”¨äºç»´æŠ¤é›†ç¾¤çš„çŠ¶æ€<br>æ¯”å¦‚:</p>
<ul>
<li>æ•…éšœæ£€æµ‹</li>
<li>è‡ªåŠ¨æ‰©å±•</li>
<li>æ»šåŠ¨æ›´æ–°</li>
</ul>
<p><strong>Scheduler:</strong>ç”¨äºè°ƒåº¦èµ„æºï¼Œæ¯”å¦‚å°†Podè°ƒåº¦åˆ°æŸä¸ªNodeä¸Š</p>
<h3 id="Node-1"><a href="#Node-1" class="headerlink" title="Node"></a>Node</h3><p><strong>Kubelet:</strong>ç”¨äºç®¡ç†å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒæ—¶ä¹Ÿè´Ÿè´£ç®¡ç†ç½‘ç»œï¼ˆCNIï¼‰å’ŒVolumeå­˜å‚¨ï¼ˆCVIï¼‰</p>
<p><strong>Container Runtime:</strong>è´Ÿè´£é•œåƒçš„ç®¡ç†ï¼Œä»¥åŠå®¹å™¨å’ŒPodçš„çœŸæ­£çš„è¿è¡Œ</p>
<p><strong>Proxy:</strong>ä¸ºserviceæä¾›clusterå†…éƒ¨çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡</p>
<h3 id="Add-on-TBD"><a href="#Add-on-TBD" class="headerlink" title="Add-on (TBD)"></a>Add-on (TBD)</h3><h2 id="DockeråŸºç¡€-ï¼ˆTBDï¼‰"><a href="#DockeråŸºç¡€-ï¼ˆTBDï¼‰" class="headerlink" title="DockeråŸºç¡€ ï¼ˆTBDï¼‰"></a>DockeråŸºç¡€ ï¼ˆTBDï¼‰</h2><h3 id="å¯¼å…¥å¯¼å‡ºimage"><a href="#å¯¼å…¥å¯¼å‡ºimage" class="headerlink" title="å¯¼å…¥å¯¼å‡ºimage"></a>å¯¼å…¥å¯¼å‡ºimage</h3><p>ä»æœ¬åœ°repositoryä¸­å¯¼å‡ºimageä¸ºå‹ç¼©åŒ…<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker save -o superset.tar amancevice/superset:latest</span><br></pre></td></tr></table></figure></p>
<p>å¯¼å…¥åˆ°æœ¬åœ°repository<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker load -i superset.tar</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p><strong>æ³¨æ„:</strong></p>
<ul>
<li>ä¹Ÿå¯ä»¥ç”¨<code>docker export</code>å’Œ<code>docker import</code></li>
<li><code>save/load</code>æ˜¯ä»imageæœ¬èº«å¯¼å‡º</li>
<li><code>export/import</code>æ˜¯ä»containerä¸­å¯¼å‡ºï¼Œå› æ­¤ä¼šå¸¦ä¸Šç”¨æˆ·åœ¨åŸå§‹é•œåƒåŸºç¡€ä¸Šçš„ä¿®æ”¹</li>
</ul>
</blockquote>
<h3 id="ä¿®æ”¹imageçš„tag"><a href="#ä¿®æ”¹imageçš„tag" class="headerlink" title="ä¿®æ”¹imageçš„tag"></a>ä¿®æ”¹imageçš„tag</h3><p>æœ‰çš„æ—¶å€™æˆ‘ä»¬æ‹‰ä¸‹æ¥çš„é•œåƒæ˜¯é»˜è®¤latestè¿™ä¸ªtagï¼Œä¸æ–¹ä¾¿æˆ‘ä»¬ç®¡ç†ç‰ˆæœ¬</p>
<p>ç”¨<code>docker inspect</code>å‘½ä»¤ä¾¦æµ‹åˆ°é•œåƒé‡Œçš„<code>VERSION</code>ä¿¡æ¯<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ol75k8sn1 ~]# docker inspect mysql|grep VERSION</span><br><span class="line">                &quot;GOSU_VERSION=1.12&quot;,</span><br><span class="line">                &quot;MYSQL_VERSION=8.0.20-1debian10&quot;</span><br><span class="line">                &quot;GOSU_VERSION=1.12&quot;,</span><br><span class="line">                &quot;MYSQL_VERSION=8.0.20-1debian10&quot;</span><br></pre></td></tr></table></figure></p>
<p>ä½¿ç”¨<code>docker tag</code>å‘½ä»¤ä¿®æ”¹é•œåƒçš„tagï¼Œæ ¼å¼ä¸º<code>é•œåƒå:ç‰ˆæœ¬tag</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ol75k8sn1 ~]# docker tag mysql mysql:v8.0.20-1debian10</span><br></pre></td></tr></table></figure></p>
<p>æ”¹å®Œåå‘ç°æœ‰ä¸¤ä¸ªåŒåï¼ŒåŒimage idï¼Œä½†tagä¸åŒçš„é•œåƒ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ol75k8sn1 ~]# docker images</span><br><span class="line">REPOSITORY                                                        TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">mysql                                                             latest              94dff5fab37f        5 days ago          541MB</span><br><span class="line">mysql                                                             v8.0.20-1debian10   94dff5fab37f        5 days ago          541MB</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>åˆ æ‰tagä¸ºlatesté‚£ä¸ªé•œåƒ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ol75k8sn1 ~]# docker rmi mysql:latest</span><br><span class="line">Untagged: mysql:latest</span><br></pre></td></tr></table></figure></p>
<h2 id="Kuberneteså®‰è£…"><a href="#Kuberneteså®‰è£…" class="headerlink" title="Kuberneteså®‰è£…"></a>Kuberneteså®‰è£…</h2><p>Kubernetesçš„å®‰è£…æœ‰å¥½3ç§æ–¹å¼ï¼šé€šè¿‡minikubeï¼Œkubeadmï¼Œé€šè¿‡äºŒè¿›åˆ¶å®‰è£…åŒ…æ‰‹åŠ¨å®‰è£…<br>minikubeç”¨æ¥éƒ¨ç½²å•èŠ‚ç‚¹é›†ç¾¤ï¼Œä¸»è¦ç”¨äºæµ‹è¯•<br>kubeadmæ˜¯è‡ªåŠ¨éƒ¨ç½²å·¥å…·<br>å»ºè®®åˆå­¦è€…é¦–æ¬¡å®‰è£…ä½¿ç”¨å®‰è£…åŒ…æ‰‹åŠ¨å®‰è£…ä¸€æ¬¡ï¼Œkubeadmè‡ªåŠ¨éƒ¨ç½²éšè—äº†å¾ˆå¤šç»†èŠ‚ï¼Œä¸åˆ©äºåˆå­¦è€…ç†è§£</p>
<h3 id="é€šè¿‡minikubeéƒ¨ç½²æµ‹è¯•ç¯å¢ƒ"><a href="#é€šè¿‡minikubeéƒ¨ç½²æµ‹è¯•ç¯å¢ƒ" class="headerlink" title="é€šè¿‡minikubeéƒ¨ç½²æµ‹è¯•ç¯å¢ƒ"></a>é€šè¿‡minikubeéƒ¨ç½²æµ‹è¯•ç¯å¢ƒ</h3><p>ä¸ºäº†ç®€åŒ–å®‰è£…ï¼Œè¿™é‡Œæˆ‘ä»¬ä¼šç”¨åˆ°<code>minikube</code><br>ä»kubernetes 1.3ç‰ˆæœ¬å¼€å§‹ï¼Œkubernetesæä¾›ä¸€ä¸ªå«åšminikubeçš„æµ‹è¯•å·¥å…·ï¼Œminikubeå¯ä»¥å¾ˆæ–¹ä¾¿çš„åœ¨æœ¬æœºåˆ›å»ºkubernetesçš„å•èŠ‚ç‚¹é›†ç¾¤<br>minikubeçš„githubé“¾æ¥ <a href="https://github.com/kubernetes/minikube" target="_blank" rel="noopener">Link</a></p>
<h4 id="å®‰è£…kubectl"><a href="#å®‰è£…kubectl" class="headerlink" title="å®‰è£…kubectl"></a>å®‰è£…kubectl</h4><p>ä¸‹è½½<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -LO https://storage.googleapis.com/kubernetes-release/release/`curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt`/bin/linux/amd64/kubectl</span><br></pre></td></tr></table></figure></p>
<p>èµ‹æƒé™</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x ./kubectl</span><br></pre></td></tr></table></figure>
<p>æŒªåˆ°<code>/usr/local/bin</code> ä¸‹<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv ./kubectl /usr/<span class="built_in">local</span>/bin/kubectl</span><br></pre></td></tr></table></figure></p>
<p>æŸ¥çœ‹å®‰è£…çš„<code>kubectl</code>çš„ç‰ˆæœ¬<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl version</span><br></pre></td></tr></table></figure></p>
<h4 id="å®‰è£…docker"><a href="#å®‰è£…docker" class="headerlink" title="å®‰è£…docker"></a>å®‰è£…docker</h4><p>é€šè¿‡yumå®‰è£…å®¹å™¨è¿è¡Œæ—¶docker</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install docker</span><br></pre></td></tr></table></figure>
<p>è®¾ç½®dockerçš„é•œåƒä»“åº“ä¸ºé˜¿é‡Œäº‘é•œåƒæœåŠ¡å™¨<br> bash<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/docker/daemon.json</span><br></pre></td></tr></table></figure></p>
<p>å…¶å†…å®¹ä¸º</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"registry-mirrors"</span>: [<span class="string">"https://xxxxxxxx.mirror.aliyuncs.com"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>https://xxxxxxxx.mirror.aliyuncs.com</code>ä¸ºä½ é€šè¿‡é˜¿é‡Œäº‘è·å¾—çš„ä¸“å±å®¹å™¨é•œåƒåŠ é€Ÿåœ°å€</p>
<p>é‡å¯dockerä½¿é…ç½®ç”Ÿæ•ˆ<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure></p>
<p>æµ‹è¯•ä¸€ä¸‹é€Ÿåº¦ï¼Œå°è¯•pullä¸€ä¸ªmysqlé•œåƒï¼Œéå¸¸å¿«<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@ol77-k8s bin]<span class="comment"># docker pull mysql</span></span><br><span class="line">Using default tag: latest</span><br><span class="line">Trying to pull repository docker.io/library/mysql ... </span><br><span class="line">latest: Pulling from docker.io/library/mysql</span><br><span class="line">6d28e14ab8c8: Pull complete </span><br><span class="line">dda15103a86a: Pull complete </span><br><span class="line">55971d75ab8c: Pull complete </span><br><span class="line">f1d4ea32020b: Pull complete </span><br><span class="line">61420072af91: Pull complete </span><br><span class="line">05c10e6ccca5: Pull complete </span><br><span class="line">7e0306b13322: Pull complete </span><br><span class="line">900b113c001e: Pull complete </span><br><span class="line">06cd07c30bf4: Pull complete </span><br><span class="line">df0d65aee5aa: Pull complete </span><br><span class="line">53eeb6e0335c: Pull complete </span><br><span class="line">6cf8f9563e97: Pull complete </span><br><span class="line">Digest: sha256:f91e704ffa9f19b9a267d9321550a0772a1b64902226d739d3527fd6edbe3dfe</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> docker.io/mysql:latest</span><br></pre></td></tr></table></figure></p>
<h5 id="ä¾‹ï¼šé€šè¿‡dockerè¿è¡Œmysql"><a href="#ä¾‹ï¼šé€šè¿‡dockerè¿è¡Œmysql" class="headerlink" title="ä¾‹ï¼šé€šè¿‡dockerè¿è¡Œmysql"></a>ä¾‹ï¼šé€šè¿‡dockerè¿è¡Œmysql</h5><p>æŸ¥çœ‹é•œåƒä»“åº“é‡Œé¢çš„image</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker search mysql</span><br></pre></td></tr></table></figure>
<p>ä»é•œåƒä»“åº“æ‹‰å–æœ€æ–°ç‰ˆçš„mysql</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql</span><br></pre></td></tr></table></figure>
<p>æˆ–è€…æ‹‰å–æŸä¸ªå›ºå®šç‰ˆæœ¬çš„mysqlï¼ˆä¾‹å¦‚tagä¸º5.7ï¼‰<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql:5.7</span><br></pre></td></tr></table></figure></p>
<p>æŸ¥çœ‹æœ¬åœ°å¯ç”¨çš„image</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure>
<p>åˆæ¬¡è¿è¡Œtagä¸º5.7çš„mysqlé•œåƒ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name demo-mysql-5.7 -p 3310:3306 -e MYSQL_ROOT_PASSWORD=123456 -itd docker.io/mysql:5.7</span><br></pre></td></tr></table></figure>
<p><code>--name demo-mysql-5.7</code>ï¼šç»™å®¹å™¨èµ·ä¸ªåå­—<br><code>-p 3310:3306</code>ï¼šå°†æœ¬æœºç«¯å£3310æ˜ å°„åˆ°å®¹å™¨çš„ç«¯å£3306<br><code>-e MYSQL_ROOT_PASSWORD=123456</code>ï¼šè®¾ç½®mysqlçš„rootå¯†ç <br><code>-itd</code>ï¼šiæ˜¯äº¤äº’å¼æ“ä½œï¼Œtæ˜¯ä¸€ä¸ªç»ˆç«¯ï¼ŒdæŒ‡çš„æ˜¯åœ¨åå°è¿è¡Œ</p>
<p>æŸ¥çœ‹å·²å¯åŠ¨çš„å®¹å™¨ (å¯ä»¥æŸ¥åˆ°å®¹å™¨idï¼Œåé¢å¯ä»¥ç”¨åå­—ä¹Ÿå¯ä»¥ç”¨å®¹å™¨idæ¥æ“ä½œ)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a</span><br></pre></td></tr></table></figure>
<p>åœæ­¢æŸè¿è¡Œçš„å®¹å™¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stop demo-mysql-5.7</span><br></pre></td></tr></table></figure>
<p>æˆ–<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker kill demo-mysql-5.7</span><br></pre></td></tr></table></figure></p>
<p>é‡æ–°å¯åŠ¨å®¹å™¨<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker start demo-mysql-5.7</span><br></pre></td></tr></table></figure></p>
<p>äº¤äº’å¼è¿æ¥åˆ°dockerçš„bashå‘½ä»¤è¡Œï¼ˆä»è€Œå¯ä»¥åœ¨dockerå†…éƒ¨æ‰§è¡Œå‘½ä»¤ï¼‰</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it demo-mysql-5.7 bash</span><br></pre></td></tr></table></figure>
<p>è¿æ¥åˆ°mysqlï¼ˆæ³¨æ„è¿™é‡Œç”¨<code>-P</code>æŒ‡å®šçš„ç«¯å£æ˜¯å¤–éƒ¨ç«¯å£ï¼Œå®ƒä¼šæŒ‰ç…§ä¹‹å‰çš„è®¾ç½®è¢«è½¬æ¢ä¸ºdockerå†…éƒ¨çš„ç«¯å£ï¼‰</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@2378f53e2bf7:/# mysql -P 3310 -u root -p</span><br></pre></td></tr></table></figure>
<p>è¿ä¸Šmysqlä¹‹åç®€å•åšä¸€ä¸ªæŸ¥è¯¢</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select version();</span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">| version() |</span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">| 5.7.29    |</span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹mysqlçš„çŠ¶æ€</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; status</span><br><span class="line">--------------</span><br><span class="line">mysql  Ver 14.14 Distrib 5.7.29, for Linux (x86_64) using  EditLine wrapper</span><br><span class="line"></span><br><span class="line">Connection id:		2</span><br><span class="line">Current database:	</span><br><span class="line">Current user:		root@localhost</span><br><span class="line">SSL:			Not in use</span><br><span class="line">Current pager:		stdout</span><br><span class="line">Using outfile:		&apos;&apos;</span><br><span class="line">Using delimiter:	;</span><br><span class="line">Server version:		5.7.29 MySQL Community Server (GPL)</span><br><span class="line">Protocol version:	10</span><br><span class="line">Connection:		Localhost via UNIX socket</span><br><span class="line">Server characterset:	latin1</span><br><span class="line">Db     characterset:	latin1</span><br><span class="line">Client characterset:	latin1</span><br><span class="line">Conn.  characterset:	latin1</span><br><span class="line">UNIX socket:		/var/run/mysqld/mysqld.sock</span><br><span class="line">Uptime:			15 min 7 sec</span><br></pre></td></tr></table></figure>
<p>åˆ é™¤å®¹å™¨ï¼ˆåˆ é™¤å‰éœ€è¦å…ˆå…³é—­å®¹å™¨ï¼‰<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rm demo-mysql-5.7</span><br></pre></td></tr></table></figure></p>
<p>åˆ é™¤æœ¬åœ°é•œåƒï¼ˆéœ€è¦å…ˆåˆ é™¤è¿è¡Œçš„å®¹å™¨ï¼‰<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi demo-mysql-5.7</span><br></pre></td></tr></table></figure></p>
<p>æŸ¥çœ‹å®¹å™¨çš„logï¼Œå¦‚ä¸‹ï¼ŒæŸ¥çœ‹æœ€å100è¡Œlog</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs --tail=100 CONTAINER_ID</span><br></pre></td></tr></table></figure>
<h4 id="å®‰è£…minikube"><a href="#å®‰è£…minikube" class="headerlink" title="å®‰è£…minikube"></a>å®‰è£…minikube</h4><p>ä¸‹è½½å’Œå®‰è£…minikube<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64 \</span><br><span class="line">   &amp;&amp; sudo install minikube-linux-amd64 /usr/<span class="built_in">local</span>/bin/minikube</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>å¦‚æœæ˜¯è¿è¡Œåœ¨ç‰©ç†æœºä¸Šï¼Œéœ€è¦åœ¨BIOSé‡Œé¢æ‰“å¼€è™šæ‹ŸåŒ–<code>VT-x</code>æˆ–<code>AMD-v</code></li>
<li>å¦‚æœæ˜¯è¿è¡Œåœ¨<code>vmware</code>ï¼Œç”±äºä¸å…è®¸åœ¨è™šæ‹Ÿå±‚ä¸Šå†å®‰è£…è™šæ‹Ÿå±‚ï¼Œå› æ­¤éœ€è¦å°†<code>vm-driver</code>è®¾ä¸º<code>none</code></li>
<li>å¦‚æœæ˜¯è¿è¡Œåœ¨<code>virtualbox</code>ä¸Šï¼Œéœ€è¦å°†<code>vm-driver</code>è®¾ä¸º<code>virtualbox</code></li>
<li>å¦‚æœæ˜¯è¿è¡Œåœ¨<code>KVM</code>ä¸Šï¼Œéœ€è¦å°†<code>vm-driver</code>è®¾ä¸º<code>kvm2</code></li>
<li>è§æ–‡æ¡£ <a href="https://minikube.sigs.k8s.io/docs/start/linux/" target="_blank" rel="noopener">Link</a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">minikube config <span class="built_in">set</span> vm-driver none</span><br></pre></td></tr></table></figure>
</li>
</ul>
</blockquote>
<p>é»˜è®¤minikubeä¼šåˆ†é…2Gå†…å­˜ï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„å‘½ä»¤æ‰©å±•åˆ°4G</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">minikube config <span class="built_in">set</span> memory 4096</span><br></pre></td></tr></table></figure>
<p>å¯åŠ¨minikubeï¼ŒåŒæ ·ç”¨<code>--registry-mirror</code>å®šä¹‰ä½¿ç”¨é˜¿é‡Œ<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">minikube start --image-mirror-country cn \</span><br><span class="line">    --iso-url=https://kubernetes.oss-cn-hangzhou.aliyuncs.com/minikube/iso/minikube-v1.7.3.iso \</span><br><span class="line">    --registry-mirror=https://xxxxxxxx.mirror.aliyuncs.com</span><br></pre></td></tr></table></figure></p>
<p>æ•´ä¸ªå¯åŠ¨è¿‡ç¨‹å¦‚ä¸‹<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@ol77-k8s bin]<span class="comment"># minikube start --image-mirror-country cn \</span></span><br><span class="line">&gt;     --iso-url=https://kubernetes.oss-cn-hangzhou.aliyuncs.com/minikube/iso/minikube-v1.7.3.iso \</span><br><span class="line">&gt;     --registry-mirror=https://xxxxxxxx.mirror.aliyuncs.com</span><br><span class="line">* minikube v1.7.3 on Oracle 7.7</span><br><span class="line">* Using the none driver based on user configuration</span><br><span class="line">* Running on localhost (CPUs=2, Memory=7965MB, Disk=83526MB) ...</span><br><span class="line">* OS release is Oracle Linux Server 7.7</span><br><span class="line">! VM is unable to access k8s.gcr.io, you may need to configure a proxy or <span class="built_in">set</span> --image-repository</span><br><span class="line">* Preparing Kubernetes v1.17.3 on Docker 1.13.1 ...</span><br><span class="line">* Downloading kubectl v1.17.3</span><br><span class="line">* Downloading kubeadm v1.17.3</span><br><span class="line">* Downloading kubelet v1.17.3</span><br><span class="line">* Launching Kubernetes ... </span><br><span class="line">* Enabling addons: default-storageclass, storage-provisioner</span><br><span class="line">* Configuring <span class="built_in">local</span> host environment ...</span><br><span class="line">* </span><br><span class="line">! The <span class="string">'none'</span> driver provides limited isolation and may reduce system security and reliability.</span><br><span class="line">! For more information, see:</span><br><span class="line">  - https://minikube.sigs.k8s.io/docs/reference/drivers/none/</span><br><span class="line">* </span><br><span class="line">! kubectl and minikube configuration will be stored <span class="keyword">in</span> /root</span><br><span class="line">! To use kubectl or minikube commands as your own user, you may need to relocate them. For example, to overwrite your own settings, run:</span><br><span class="line">* </span><br><span class="line">  - sudo mv /root/.kube /root/.minikube <span class="variable">$HOME</span></span><br><span class="line">  - sudo chown -R <span class="variable">$USER</span> <span class="variable">$HOME</span>/.kube <span class="variable">$HOME</span>/.minikube</span><br><span class="line">* </span><br><span class="line">* This can also be <span class="keyword">done</span> automatically by setting the env var CHANGE_MINIKUBE_NONE_USER=<span class="literal">true</span></span><br><span class="line">* Waiting <span class="keyword">for</span> cluster to come online ...</span><br><span class="line">* Done! kubectl is now configured to use <span class="string">"minikube"</span></span><br><span class="line">* For best results, install kubectl: https://kubernetes.io/docs/tasks/tools/install-kubectl/</span><br></pre></td></tr></table></figure></p>
<p>ä¹‹åå°±å¯ä»¥ä½¿ç”¨kubectlæ¥æ“ä½œkubernetes</p>
<p>æ‰“å¼€kubernetesæ§åˆ¶å°</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ol77-k8s Downloads]<span class="comment"># minikube dashboard</span></span><br><span class="line">* Enabling dashboard ...</span><br><span class="line">* Verifying dashboard health ...</span><br><span class="line">* Launching proxy ...</span><br><span class="line">* Verifying proxy health ...</span><br><span class="line">http://127.0.0.1:34155/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/</span><br></pre></td></tr></table></figure>
<p><img src="/2020/02/15/Kubernetes-K8S/./Pict_20200228_002.jpg" alt="Alt text"></p>
<h3 id="é€šè¿‡kubeadméƒ¨ç½²é›†ç¾¤"><a href="#é€šè¿‡kubeadméƒ¨ç½²é›†ç¾¤" class="headerlink" title="é€šè¿‡kubeadméƒ¨ç½²é›†ç¾¤"></a>é€šè¿‡kubeadméƒ¨ç½²é›†ç¾¤</h3><h4 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h4><h5 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h5><p>Oracle Linux 7.x<br>Kubernetes 1.18</p>
<h5 id="é…ç½®èŠ‚ç‚¹ç¯å¢ƒ"><a href="#é…ç½®èŠ‚ç‚¹ç¯å¢ƒ" class="headerlink" title="é…ç½®èŠ‚ç‚¹ç¯å¢ƒ"></a>é…ç½®èŠ‚ç‚¹ç¯å¢ƒ</h5><p>ç³»ç»Ÿè¦æ±‚å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ¯ä¸ªèŠ‚ç‚¹CPUè‡³å°‘2æ ¸ï¼Œå†…å­˜è‡³å°‘2G</li>
<li>hostnameï¼ŒMACåœ°å€ï¼Œproduct_uuidæ¯ä¸ªèŠ‚ç‚¹å¿…é¡»ä¸åŒ<br>hostnameåœ¨Oracle Linux 7.xä¸­å¯ä»¥é€šè¿‡<code>hostnamectl set-hostname</code>è®¾ç½®<br>product_uuidkeå¯ä»¥é€šè¿‡<code>cat /sys/class/dmi/id/product_uuid</code>æŸ¥çœ‹</li>
</ul>
<p>æœ¬æ¬¡3ä¸ªèŠ‚ç‚¹é…ç½®å¦‚ä¸‹ï¼š<br>| IP      |     è§’è‰² |   CPU   |   å†…å­˜   |   ä¸»æœºå   |<br>| :â€”â€”â€“ | :â€”â€”: | :â€”â€”: | :â€”â€”: | :â€”â€”: |<br>| 192.168.1.81 | master | 2æ ¸ | 4G | ol75k8sn1 |<br>| 192.168.1.82 | master | 2æ ¸ | 4G | ol75k8sn2 |<br>| 192.168.1.83 | master | 2æ ¸ | 4G | ol75k8sn3 |</p>
<p>åœ¨<code>/etc/hosts</code> ä¸­æ·»åŠ 3ä¸ªèŠ‚ç‚¹çš„IPè§£æ<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ol75k8sn1 ~]<span class="comment"># cat /etc/hosts</span></span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.1.81    ol75k8sn1</span><br><span class="line">192.168.1.82    ol75k8sn2</span><br><span class="line">192.168.1.83    ol75k8sn3</span><br></pre></td></tr></table></figure></p>
<h5 id="æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨"><a href="#æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨" class="headerlink" title="æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨"></a>æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨</h5><p>K8Sé»˜è®¤ç«¯å£å¦‚ä¸‹å›¾<br><img src="/2020/02/15/Kubernetes-K8S/./Pict_20200412_001.jpg" alt="Alt text"></p>
<p>å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹æ³•æŸ¥çœ‹ç«¯å£å ç”¨<br><strong>æ–¹æ³•ä¸€ï¼š</strong><br>æŸ¥çœ‹æœ¬æœºæ‰€æœ‰ç«¯å£<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -tunlp</span><br></pre></td></tr></table></figure></p>
<p>æŸ¥çœ‹ç‰¹å®šç«¯å£<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -tunlp | grep 8080</span><br></pre></td></tr></table></figure></p>
<p><strong>æ–¹æ³•äºŒï¼š</strong><br>æŸ¥çœ‹ç‰¹å®šç«¯å£<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof -i:8080</span><br></pre></td></tr></table></figure></p>
<h5 id="ç¦ç”¨swap"><a href="#ç¦ç”¨swap" class="headerlink" title="ç¦ç”¨swap"></a>ç¦ç”¨swap</h5><p>swapä¼šé™ä½K8Sçš„æ€§èƒ½</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a</span><br></pre></td></tr></table></figure>
<p>æ³¨é‡Šæ‰<code>/etc/fstab</code>ä¸­çš„swap</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># /etc/fstab</span></span><br><span class="line"><span class="comment"># Created by anaconda on Mon Oct 21 06:40:15 2019</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Accessible filesystems, by reference, are maintained under '/dev/disk'</span></span><br><span class="line"><span class="comment"># See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">/dev/mapper/ol-root     /                       ext4    defaults        1 1</span><br><span class="line">UUID=6ed9c74f-dfba-4d20-9a75-16a6c1351b72 /boot                   xfs     defaults        0 0</span><br><span class="line"><span class="comment">#/dev/mapper/ol-swap     swap                    swap    defaults        0 0</span></span><br></pre></td></tr></table></figure>
<p>æ— éœ€é‡å¯</p>
<h5 id="å…³é—­selinux"><a href="#å…³é—­selinux" class="headerlink" title="å…³é—­selinux"></a>å…³é—­selinux</h5><p>ä¿®æ”¹é…ç½®æ–‡ä»¶<code>/etc/selinux/config</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELINUX=disabled</span><br></pre></td></tr></table></figure></p>
<p>é‡å¯ç”Ÿæ•ˆ</p>
<h5 id="å…³é—­é˜²ç«å¢™"><a href="#å…³é—­é˜²ç«å¢™" class="headerlink" title="å…³é—­é˜²ç«å¢™"></a>å…³é—­é˜²ç«å¢™</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br></pre></td></tr></table></figure>
<h5 id="è½½å…¥å¿…è¦çš„å†…æ ¸æ¨¡å—"><a href="#è½½å…¥å¿…è¦çš„å†…æ ¸æ¨¡å—" class="headerlink" title="è½½å…¥å¿…è¦çš„å†…æ ¸æ¨¡å—"></a>è½½å…¥å¿…è¦çš„å†…æ ¸æ¨¡å—</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">modprobe br_netfilter</span><br><span class="line">cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF</span><br><span class="line">#!/bin/bash</span><br><span class="line">modprobe -- ip_vs</span><br><span class="line">modprobe -- ip_vs_rr</span><br><span class="line">modprobe -- ip_vs_wrr</span><br><span class="line">modprobe -- ip_vs_sh</span><br><span class="line">modprobe -- nf_conntrack_ipv4</span><br><span class="line">EOF</span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules</span><br><span class="line">bash /etc/sysconfig/modules/ipvs.modules</span><br><span class="line">lsmod | grep -e ip_vs -e nf_conntrack_ipv4</span><br></pre></td></tr></table></figure>
<h5 id="é…ç½®å›½å†…yumæº"><a href="#é…ç½®å›½å†…yumæº" class="headerlink" title="é…ç½®å›½å†…yumæº"></a>é…ç½®å›½å†…yumæº</h5><p>æ·»åŠ é˜¿é‡Œäº‘çš„centoså’Œepelæº<br>è§ <a href="https://shenpeng1982.github.io/2019/02/09/%E8%87%AA%E5%AE%9A%E4%B9%89YUM%E6%BA%90/" target="_blank" rel="noopener">GitPage Link</a></p>
<p>æ·»åŠ é˜¿é‡Œäº‘docker-ceçš„yumæº<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure></p>
<p>æ·»åŠ é˜¿é‡Œäº‘K8Sçš„yumæº</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>å¯ä»¥ä¸åšç¼“å­˜<code>yum makecache</code>ï¼Œåœ¨ç§»åŠ¨ç½‘ç»œä¸‹ï¼Œæ—¶é—´è¾ƒé•¿</li>
</ul>
</blockquote>
<h5 id="å®‰è£…å¿…é¡»çš„è½¯ä»¶åŒ…"><a href="#å®‰è£…å¿…é¡»çš„è½¯ä»¶åŒ…" class="headerlink" title="å®‰è£…å¿…é¡»çš„è½¯ä»¶åŒ…"></a>å®‰è£…å¿…é¡»çš„è½¯ä»¶åŒ…</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y screen conntrack ntp ipvsadm ipset jq iptables curl sysstat libseccomp wget vim net-tools git</span><br></pre></td></tr></table></figure>
<h5 id="åŒæ­¥æ—¶é—´"><a href="#åŒæ­¥æ—¶é—´" class="headerlink" title="åŒæ­¥æ—¶é—´"></a>åŒæ­¥æ—¶é—´</h5><p>é€šè¿‡ç½‘ç»œntpæœåŠ¡å™¨åŒæ­¥ä¸€ä¸‹å„ä¸ªèŠ‚ç‚¹çš„ç³»ç»Ÿæ—¶é—´<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y ntpdate</span><br><span class="line">/usr/sbin/ntpdate ntp1.aliyun.com</span><br></pre></td></tr></table></figure></p>
<p>å¦‚æœæ˜¯åœ¨å®ä½“æœºå®‰è£…ï¼Œæ—¶é’Ÿåˆ†ç¡¬ä»¶æ—¶é’Ÿå’Œç³»ç»Ÿæ—¶é’Ÿ<br>é€šè¿‡<code>hwclock</code>æŸ¥çœ‹ç¡¬ä»¶æ—¶é’Ÿ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@labk8sn1 ~]# hwclock</span><br><span class="line">Mon 25 May 2020 04:58:14 PM CST  -0.766585 seconds</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡<code>date</code>æŸ¥çœ‹ç³»ç»Ÿæ—¶é’Ÿ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@labk8sn1 ~]# date</span><br><span class="line">Mon May 25 16:56:10 CST 2020</span><br></pre></td></tr></table></figure>
<p>å°†ç¡¬ä»¶æ—¶é’ŸåŒæ­¥åˆ°ç³»ç»Ÿæ—¶é’Ÿï¼ˆä»¥ç¡¬ä»¶æ—¶é’Ÿä¸ºå‡†ï¼‰</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hwclock --hctosys</span><br></pre></td></tr></table></figure>
<p>å°†ç³»ç»Ÿæ—¶é’ŸåŒæ­¥åˆ°ç¡¬ä»¶æ—¶é’Ÿï¼ˆä»¥ç³»ç»Ÿæ—¶é’Ÿä¸ºå‡†ï¼‰</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hwclock --systohc</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>åœ¨æœ¬ä¾‹ä¸­ï¼Œé¦–å…ˆé€šè¿‡ç½‘ç»œåŒæ­¥äº†ç³»ç»Ÿæ—¶é—´ï¼Œæ‰€ä»¥ç°åœ¨éœ€è¦å°†ç³»ç»Ÿæ—¶é—´åŒæ­¥ç»™ç¡¬ä»¶æ—¶é—´</li>
</ul>
</blockquote>
<h5 id="æ‰“å¼€IPè½¬å‘"><a href="#æ‰“å¼€IPè½¬å‘" class="headerlink" title="æ‰“å¼€IPè½¬å‘"></a>æ‰“å¼€IPè½¬å‘</h5><p>Linuxé»˜è®¤<code>/proc/sys/net/ipv4/ip_forward</code>çš„å€¼æ˜¯0ï¼Œä¹Ÿå°±æ˜¯ç¦æ­¢è½¬å‘</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;1&quot; &gt; /proc/sys/net/ipv4/ip_forward</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>é‡å¯ç½‘ç»œæˆ–é‡å¯æœåŠ¡å™¨åæ•ˆæœä¸å†</li>
</ul>
</blockquote>
<p>å› æ­¤ï¼Œå°†<code>echo &quot;1&quot; &gt; /proc/sys/net/ipv4/ip_forward</code>å†™å…¥<code>/etc/rc.d/rc.local</code>ä¿è¯å¼€æœºæ—¶æ‰§è¡Œ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/rc.d/rc.local</span><br><span class="line">echo &quot;1&quot; &gt; /proc/sys/net/ipv4/ip_forward</span><br></pre></td></tr></table></figure></p>
<h5 id="å®‰è£…iptables"><a href="#å®‰è£…iptables" class="headerlink" title="å®‰è£…iptables"></a>å®‰è£…iptables</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum -y install iptables-services</span><br><span class="line">systemctl start iptables</span><br><span class="line">systemctl enable iptables</span><br><span class="line">iptables -F</span><br><span class="line">service iptables save</span><br></pre></td></tr></table></figure>
<h5 id="ä¿®æ”¹é»˜è®¤iptablesçš„ç½‘æ¡¥è®¾ç½®"><a href="#ä¿®æ”¹é»˜è®¤iptablesçš„ç½‘æ¡¥è®¾ç½®" class="headerlink" title="ä¿®æ”¹é»˜è®¤iptablesçš„ç½‘æ¡¥è®¾ç½®"></a>ä¿®æ”¹é»˜è®¤iptablesçš„ç½‘æ¡¥è®¾ç½®</h5><p>é¦–å…ˆä¿è¯å†…æ ¸æ¨¡å—<code>br_netfilter</code>å·²ç»åŠ è½½</p>
<p>é»˜è®¤ä¸‹é¢è¿™å‡ ä¸ªå‚æ•°çš„å€¼éƒ½æ˜¯0ï¼Œæ„å‘³ç€iptablesä¸å¯¹ç½‘æ¡¥(bridge)æ•°æ®è¿›è¡Œå¤„ç†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net.bridge.bridge-nf-call-ip6tables = 0</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 0</span><br><span class="line">net.bridge.bridge-nf-call-arptables = 0</span><br></pre></td></tr></table></figure>
<p>K8Sè¦æ±‚è¿™å‡ ä¸ªå¼€å…³æ‰“å¼€ï¼Œiptablesèƒ½çœ‹åˆ°å’Œå¤„ç†ç½‘æ¡¥æ•°æ®<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.bridge.bridge-nf-call-arptables = 1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p>ç”Ÿæ•ˆ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl --system</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå¯ä»¥æŠŠè¿™å‡ ä¸ªå‚æ•°æ”¾åœ¨<code>/etc/sysctl.conf</code>é‡Œé¢ï¼Œç„¶åé€šè¿‡<code>/sbin/sysctl -p</code>ç”Ÿæ•ˆ</p>
<h5 id="æ—¥å¿—æŒä¹…åŒ–è®¾ç½®-ï¼ˆTBDï¼‰"><a href="#æ—¥å¿—æŒä¹…åŒ–è®¾ç½®-ï¼ˆTBDï¼‰" class="headerlink" title="æ—¥å¿—æŒä¹…åŒ–è®¾ç½® ï¼ˆTBDï¼‰"></a>æ—¥å¿—æŒä¹…åŒ–è®¾ç½® ï¼ˆTBDï¼‰</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># è®¾ç½® rsyslogd å’Œ systemd journald</span><br><span class="line">mkdir -p /var/log/journal # æŒä¹…åŒ–ä¿å­˜æ—¥å¿—çš„ç›®å½•</span><br><span class="line">mkdir -p /etc/systemd/journald.conf.d</span><br><span class="line">cat &gt; /etc/systemd/journald.conf.d/99-prophet.conf &lt;&lt;EOF</span><br><span class="line">[Journal]</span><br><span class="line"># æŒä¹…åŒ–ä¿å­˜åˆ°ç£ç›˜</span><br><span class="line">Storage=persistent</span><br><span class="line"># å‹ç¼©å†å²æ—¥å¿—</span><br><span class="line">Compress=yes</span><br><span class="line">SyncIntervalSec=5m</span><br><span class="line">RateLimitInterval=30s</span><br><span class="line">RateLimitBurst=1000</span><br><span class="line"># æœ€å¤§å ç”¨ç©ºé—´10G</span><br><span class="line">SystemMaxUse=10G</span><br><span class="line"># å•æ—¥å¿—æ–‡ä»¶æœ€å¤§200M</span><br><span class="line">SystemMaxFileSize=200M</span><br><span class="line"># æ—¥å¿—ä¿å­˜æ—¶é—´2å‘¨</span><br><span class="line">MaxRetentionSec=2week</span><br><span class="line"># ä¸å°†æ—¥å¿—è½¬å‘åˆ°syslog</span><br><span class="line">ForwardToSyslog=no</span><br><span class="line">EOF</span><br><span class="line">systemctl restart systemd-journald</span><br></pre></td></tr></table></figure>
<h4 id="å®‰è£…å®¹å™¨è¿è¡Œæ—¶docker"><a href="#å®‰è£…å®¹å™¨è¿è¡Œæ—¶docker" class="headerlink" title="å®‰è£…å®¹å™¨è¿è¡Œæ—¶docker"></a>å®‰è£…å®¹å™¨è¿è¡Œæ—¶docker</h4><p><code>docker-io</code>å’Œ<code>docker-engin</code>æ˜¯æ—©æœŸç‰ˆæœ¬ï¼Œç‰ˆæœ¬å·æ˜¯1.xï¼ŒOracle Linux 7.xï¼ŒRedhat Enterprise Linux 7.xå’ŒCentos 7.xé»˜è®¤å®‰è£…çš„æ˜¯<code>docker-io</code>ï¼Œæœ€æ–°ç‰ˆæ˜¯1.13ã€‚<br><code>docker-ce</code>æ˜¯ç¤¾åŒºç‰ˆï¼ŒUbuntué»˜è®¤å®‰è£…çš„æ˜¯<code>docker-ce</code>ï¼Œæœ€æ–°ç‰ˆæœ¬æ˜¯19.03<br><code>docker-ee</code>æ˜¯ä¼ä¸šç‰ˆã€‚</p>
<p>åˆ—å‡ºå¯ä»¥å®‰è£…çš„ç‰ˆæœ¬<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@ol75k8sn1 ~]<span class="comment"># yum list docker-ce</span></span><br><span class="line">Loaded plugins: langpacks, ulninfo</span><br><span class="line">Available Packages</span><br><span class="line">docker-ce.x86_64                                        3:19.03.8-3.el7                                        docker-ce-stable</span><br></pre></td></tr></table></figure></p>
<p>å®‰è£…ä¸­å¦‚æœ‰å¦‚ä¸‹æŠ¥é”™ä¿¡æ¯ï¼Œä¸€èˆ¬åŸå› è¿˜æ˜¯å›½å†…çš„æºä¸­åŒ…ä¸å…¨ï¼Œä¸€èˆ¬æ·»åŠ é˜¿é‡Œçš„centoså’Œepelæºä¹‹åéƒ½æ²¡æœ‰é—®é¢˜<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Error: Package: 3:docker-ce-19.03.8-3.el7.x86_64 (docker-ce-stable)</span><br><span class="line">           Requires: container-selinux &gt;= 2:2.74</span><br><span class="line">Error: Package: containerd.io-1.2.13-3.1.el7.x86_64 (docker-ce-stable)</span><br><span class="line">           Requires: container-selinux &gt;= 2:2.74</span><br></pre></td></tr></table></figure></p>
<p>å¦‚æœè¿˜æ˜¯æŠ¥é”™ï¼Œéœ€è¦æ‰‹åŠ¨åˆ°<a href="https://pkgs.org/download" target="_blank" rel="noopener">https://pkgs.org/download</a>å»ä¸‹è½½å®‰è£…</p>
<p>å®‰è£…<code>docker-ce</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install docker-ce</span><br></pre></td></tr></table></figure>
<p>è®¾ç½®å¼€æœºè‡ªå¯åŠ¨<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable docker</span><br></pre></td></tr></table></figure></p>
<p>å¯åŠ¨docker<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start docker</span><br></pre></td></tr></table></figure></p>
<h4 id="å®‰è£…kubernetesé›†ç¾¤"><a href="#å®‰è£…kubernetesé›†ç¾¤" class="headerlink" title="å®‰è£…kubernetesé›†ç¾¤"></a>å®‰è£…kubernetesé›†ç¾¤</h4><p>åœ¨æ‰€æœ‰èŠ‚ç‚¹å®‰è£…kubeletï¼Œkubeadmå’Œkubectl<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install kubelet kubeadm kubectl</span><br></pre></td></tr></table></figure></p>
<p>è®¾ç½®å¼€æœºè‡ªå¯åŠ¨kubelet<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable kubelet</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>ä»è¿™ä¸ªæ—¶å€™å¼€å§‹ï¼Œå¯ä»¥ä»node1å…‹éš†è™šæ‹Ÿæœºä¸ºnode2ï¼Œnode3ä»¥ç®€åŒ–å®‰è£…æ“ä½œ</li>
</ul>
</blockquote>
<p>kubeletçš„serviceç°åœ¨å¯åŠ¨ä¼šæŠ¥é”™ï¼Œè¿™æ˜¯æ­£å¸¸æƒ…å†µï¼Œåœ¨ä¸‹ä¸€èŠ‚kubeadm initåˆå§‹åŒ–ä¹‹åï¼Œé‡å¯kubeletå³å¯</p>
<h5 id="åˆå§‹åŒ–ä¸»èŠ‚ç‚¹"><a href="#åˆå§‹åŒ–ä¸»èŠ‚ç‚¹" class="headerlink" title="åˆå§‹åŒ–ä¸»èŠ‚ç‚¹"></a>åˆå§‹åŒ–ä¸»èŠ‚ç‚¹</h5><p>ç”¨ä¸‹é¢çš„å‘½ä»¤åœ¨ä¸»èŠ‚ç‚¹ä¸Šåˆå§‹åŒ–<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --image-repository=registry.aliyuncs.com/google_containers --kubernetes-version=v1.18.0 --pod-network-cidr=192.168.0.0/16</span><br></pre></td></tr></table></figure></p>
<ul>
<li>â€“image-repositoryï¼šæŒ‡å®šä»“åº“åœ°å€ï¼Œè¿™é‡ŒæŒ‡å®šé˜¿é‡Œäº‘çš„ä»“åº“</li>
<li>â€“kubernetes-versionï¼šæŒ‡å®šå®‰è£…çš„kubernetesç‰ˆæœ¬</li>
<li>â€“pod-network-cidrï¼šæŒ‡å®špodçš„åœ°å€å–å€¼ç½‘æ®µ</li>
</ul>
<p>æ‰§è¡Œå‘½ä»¤ç›´åˆ°çœ‹åˆ°å‡ºç°æˆåŠŸçš„ä¿¡æ¯</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm join 192.168.1.81:6443 --token jqd1u2.oeetwxopk4h18mjp \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:be840f62afba37facbdf3e9d9aa487c3b65bf7c06fc7dce65c32662c4a1cd41d</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®ä¸Šé¢æç¤ºï¼Œä¸»èŠ‚ç‚¹ä¸Šæ‹·è´ä¸»èŠ‚ç‚¹çš„Kubernetesé…ç½®æ–‡ä»¶åˆ°ç”¨æˆ·ç›®å½•ä¸‹é¢ï¼Œå¦åˆ™ä½¿ç”¨kubectlæ—¶ä¼šæŠ¥é”™æç¤ºæ²¡æœ‰é…ç½®<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>åœ¨å­ç»“ç‚¹ä¸Šï¼Œåœ¨<code>kubeadm join</code>ä¹‹å‰ï¼Œä¸è¦æ‹·è´ç”Ÿæˆ<code>$HOME/.kube/config</code>ï¼Œå¦åˆ™<code>kubectl join</code>ä¼šå¤±è´¥</li>
<li><code>kubeadm init</code>å’Œ<code>kubeadm join</code>ä¹‹å‰ï¼Œæ— éœ€å¯åŠ¨<code>kubelet</code></li>
</ul>
</blockquote>
<h5 id="å®‰è£…ç½‘ç»œæ’ä»¶"><a href="#å®‰è£…ç½‘ç»œæ’ä»¶" class="headerlink" title="å®‰è£…ç½‘ç»œæ’ä»¶"></a>å®‰è£…ç½‘ç»œæ’ä»¶</h5><p>Calicoæˆ–flanneléƒ½å¯ä»¥</p>
<h6 id="é…ç½®Calico"><a href="#é…ç½®Calico" class="headerlink" title="é…ç½®Calico"></a>é…ç½®Calico</h6><p>Calico æ˜¯ä¸€æ¬¾çº¯ Layer 3 çš„æ•°æ®ä¸­å¿ƒç½‘ç»œæ–¹æ¡ˆ(ä¸éœ€è¦ Overlay ç½‘ç»œ)ï¼ŒCalico å¥½å¤„æ˜¯ä»–å·²ä¸å„ç§äº‘åŸç”Ÿå¹³å°æœ‰è‰¯å¥½çš„æ•´åˆï¼Œè€Œ Calico åœ¨æ¯ä¸€ä¸ªèŠ‚ç‚¹åˆ©ç”¨ Linux Kernel å®ç°é«˜æ•ˆçš„ vRouter æ¥è´Ÿè´£æ•°æ®çš„è½¬å‘ï¼Œè€Œå½“æ•°æ®ä¸­å¿ƒå¤æ‚åº¦å¢åŠ æ—¶ï¼Œå¯ä»¥ç”¨ BGP route reflector æ¥è¾¾æˆ</p>
<p>å®˜æ–¹æ•™ç¨‹ <a href="https://docs.projectcalico.org/getting-started/kubernetes/" target="_blank" rel="noopener">Link</a></p>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>Calicoé»˜è®¤çš„IPæ®µæ˜¯<code>192.168.0.0/16</code>ï¼Œå¦‚æœå’Œä½ çš„éœ€æ±‚ä¸ä¸€è‡´ï¼Œè¯·åœ¨masterèŠ‚ç‚¹é€šè¿‡<code>kubeadm init</code>åˆå§‹åŒ–æ—¶é€šè¿‡<code>--pod-network-cidr</code>æ›´æ”¹</li>
</ul>
</blockquote>
<p>åº”ç”¨<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml</span><br></pre></td></tr></table></figure></p>
<p>æŸ¥çœ‹podçŠ¶æ€<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods --all-namespaces</span><br></pre></td></tr></table></figure></p>
<p>æ‰€æœ‰çš„podçŠ¶æ€éƒ½åº”è¯¥æ˜¯<code>running</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@ol75k8sn1 ~]# kubectl get pods --all-namespaces</span><br><span class="line">NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   calico-kube-controllers-6fcbbfb6fb-hxrqh   1/1     Running   0          9d</span><br><span class="line">kube-system   calico-node-dk9gq                          1/1     Running   0          9d</span><br><span class="line">kube-system   calico-node-qw57c                          1/1     Running   0          21m</span><br><span class="line">kube-system   calico-node-slcqv                          1/1     Running   0          21m</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<h6 id="é…ç½®Flannelï¼ˆCalicoå’ŒFlanneläºŒé€‰ä¸€ï¼‰"><a href="#é…ç½®Flannelï¼ˆCalicoå’ŒFlanneläºŒé€‰ä¸€ï¼‰" class="headerlink" title="é…ç½®Flannelï¼ˆCalicoå’ŒFlanneläºŒé€‰ä¸€ï¼‰"></a>é…ç½®Flannelï¼ˆCalicoå’ŒFlanneläºŒé€‰ä¸€ï¼‰</h6><p>flannelåªéœ€è¦åœ¨NodeèŠ‚ç‚¹å®‰è£…,MasterèŠ‚ç‚¹æ— éœ€å®‰è£…</p>
<p>docker import flannel-v0.11.0-linux-amd64.tar quay.io/coreos/flannel:v0.11.0-arm64</p>
<p>kubectl apply -f kube-flannel.yml</p>
<h5 id="åŠ å…¥å­èŠ‚ç‚¹"><a href="#åŠ å…¥å­èŠ‚ç‚¹" class="headerlink" title="åŠ å…¥å­èŠ‚ç‚¹"></a>åŠ å…¥å­èŠ‚ç‚¹</h5><p>å°†å…¶ä½™ä¸¤ä¸ªèŠ‚ç‚¹åŠ å…¥<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.1.81:6443 --token n556jt.wnkqsc536gzw8xvk \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:819a6cab80a0c617f972a9e04c71d1fbff92c383ce66d2e6a13f2106c7e960ad</span><br></pre></td></tr></table></figure></p>
<p>æŸ¥çœ‹é›†ç¾¤çš„çŠ¶æ€ï¼Œå¯ä»¥çœ‹åˆ°statuså’Œrolesè¿˜ä¸æ­£å¸¸ï¼Œè¿™ä¸»è¦æ˜¯å› ä¸ºè¿˜æ²¡æœ‰å®‰è£…ç½‘ç»œæ’ä»¶<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ol75k8sn1 ~]# kubectl get nodes</span><br><span class="line">NAME        STATUS     ROLES    AGE     VERSION</span><br><span class="line">ol75k8sn1   NotReady   master   3h40m   v1.18.2</span><br><span class="line">ol75k8sn2   NotReady   &lt;none&gt;   7m48s   v1.18.2</span><br><span class="line">ol75k8sn3   NotReady   &lt;none&gt;   8m13s   v1.18.2</span><br></pre></td></tr></table></figure></p>
<h6 id="Toubleshootingï¼šTokenå¤±æ•ˆåå¦‚ä½•åŠ å…¥å­èŠ‚ç‚¹"><a href="#Toubleshootingï¼šTokenå¤±æ•ˆåå¦‚ä½•åŠ å…¥å­èŠ‚ç‚¹" class="headerlink" title="Toubleshootingï¼šTokenå¤±æ•ˆåå¦‚ä½•åŠ å…¥å­èŠ‚ç‚¹"></a>Toubleshootingï¼šTokenå¤±æ•ˆåå¦‚ä½•åŠ å…¥å­èŠ‚ç‚¹</h6><p>åœ¨1.8ç‰ˆä¹‹åï¼Œé»˜è®¤ç”Ÿæˆçš„ token æœ‰æ•ˆæœŸåªæœ‰ 24 å°æ—¶<br>åœ¨masterèŠ‚ç‚¹ä¸Šé‡æ–°ç”Ÿæˆtoken<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@ol75k8sn1 ~]<span class="comment"># kubeadm token create</span></span><br><span class="line">W0505 18:33:08.907564   25966 configset.go:202] WARNING: kubeadm cannot validate component configs <span class="keyword">for</span> API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]</span><br><span class="line">fo2k3z.mpfllk3gextyuqoa</span><br></pre></td></tr></table></figure></p>
<p>è·å– CA è¯ä¹¦ sha256 ç¼–ç çš„ hash å€¼<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ol75k8sn1 ~]# openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed &apos;s/^.* //&apos;</span><br><span class="line">be840f62afba37facbdf3e9d9aa487c3b65bf7c06fc7dce65c32662c4a1cd41d</span><br></pre></td></tr></table></figure></p>
<p>æ ¹æ®ä¸Šé¢çš„ç»“æœï¼Œé‡æ–°ç”Ÿæˆ<code>kubeadm join</code>è¯­å¥<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.1.81:6443 --token fo2k3z.mpfllk3gextyuqoa \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:be840f62afba37facbdf3e9d9aa487c3b65bf7c06fc7dce65c32662c4a1cd41d</span><br></pre></td></tr></table></figure></p>
<h4 id="æ‰«å°¾æ’é”™å·¥ä½œ"><a href="#æ‰«å°¾æ’é”™å·¥ä½œ" class="headerlink" title="æ‰«å°¾æ’é”™å·¥ä½œ"></a>æ‰«å°¾æ’é”™å·¥ä½œ</h4><h5 id="CASE-1"><a href="#CASE-1" class="headerlink" title="CASE 1"></a>CASE 1</h5><p>æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€éƒ½æ˜¯<code>Ready</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ol75k8sn1 ~]# kubectl get nodes</span><br><span class="line">NAME        STATUS   ROLES    AGE     VERSION</span><br><span class="line">ol75k8sn1   Ready    master   9d      v1.18.2</span><br><span class="line">ol75k8sn2   Ready    &lt;none&gt;   6h22m   v1.18.2</span><br><span class="line">ol75k8sn3   Ready    &lt;none&gt;   6h22m   v1.18.2</span><br></pre></td></tr></table></figure></p>
<p>ä½†kubeletè™½ç„¶æ˜¯<code>running</code>çŠ¶æ€çš„logä¾ç„¶æŠ¥é”™<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@ol75k8sn1 ~]<span class="comment"># systemctl status kubelet</span></span><br><span class="line">â— kubelet.service - kubelet: The Kubernetes Node Agent</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kubelet.service; enabled; vendor preset: disabled)</span><br><span class="line">  Drop-In: /usr/lib/systemd/system/kubelet.service.d</span><br><span class="line">           â””â”€10-kubeadm.conf</span><br><span class="line">   Active: active (running) since Wed 2020-05-06 01:10:12 CST; 17min ago</span><br><span class="line">     Docs: https://kubernetes.io/docs/</span><br><span class="line"> Main PID: 735 (kubelet)</span><br><span class="line">   Memory: 112.3M</span><br><span class="line">   CGroup: /system.slice/kubelet.service</span><br><span class="line">           â””â”€735 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubern...</span><br><span class="line"></span><br><span class="line">May 06 01:26:27 ol75k8sn1 kubelet[735]: W0506 01:26:27.945469     735 qos_container_manager_linux.go:138] [Contain...: pids</span><br><span class="line">May 06 01:26:30 ol75k8sn1 kubelet[735]: E0506 01:26:30.167506     735 summary_sys_containers.go:47] Failed to get system...</span><br><span class="line">May 06 01:26:40 ol75k8sn1 kubelet[735]: E0506 01:26:40.298518     735 summary_sys_containers.go:47] Failed to get system...</span><br><span class="line">May 06 01:26:50 ol75k8sn1 kubelet[735]: E0506 01:26:50.327160     735 summary_sys_containers.go:47] Failed to get system...</span><br><span class="line">May 06 01:27:00 ol75k8sn1 kubelet[735]: E0506 01:27:00.347778     735 summary_sys_containers.go:47] Failed to get system...</span><br><span class="line">May 06 01:27:10 ol75k8sn1 kubelet[735]: E0506 01:27:10.368074     735 summary_sys_containers.go:47] Failed to get system...</span><br><span class="line">May 06 01:27:20 ol75k8sn1 kubelet[735]: E0506 01:27:20.388551     735 summary_sys_containers.go:47] Failed to get system...</span><br><span class="line">May 06 01:27:27 ol75k8sn1 kubelet[735]: E0506 01:27:27.946584     735 qos_container_manager_linux.go:328] [Contain...ration</span><br><span class="line">May 06 01:27:27 ol75k8sn1 kubelet[735]: W0506 01:27:27.946605     735 qos_container_manager_linux.go:138] [Contain...: pids</span><br><span class="line">May 06 01:27:30 ol75k8sn1 kubelet[735]: E0506 01:27:30.411942     735 summary_sys_containers.go:47] Failed to get system...</span><br><span class="line">Hint: Some lines were ellipsized, use -l to show <span class="keyword">in</span> full.</span><br></pre></td></tr></table></figure></p>
<p>æ ¹æ®æç¤ºç”¨<code>systemctl status kubelet -l</code>æ¥æŸ¥çœ‹å®Œæ•´çš„æŠ¥é”™ä¿¡æ¯ï¼Œå¦‚ä¸‹<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">May 06 01:23:27 ol75k8sn1 kubelet[735]: W0506 01:23:27.935354     735 qos_container_manager_linux.go:138] [ContainerManager] Failed to reserve QoS requests: failed to <span class="built_in">set</span> supported cgroup subsystems <span class="keyword">for</span> cgroup [kubepods burstable]: failed to find subsystem mount <span class="keyword">for</span> required subsystem: pids</span><br><span class="line">May 06 01:23:29 ol75k8sn1 kubelet[735]: E0506 01:23:29.752777     735 summary_sys_containers.go:47] Failed to get system container stats <span class="keyword">for</span> <span class="string">"/system.slice/docker.service"</span>: failed to get cgroup stats <span class="keyword">for</span> <span class="string">"/system.slice/docker.service"</span>: failed to get container info <span class="keyword">for</span> <span class="string">"/system.slice/docker.service"</span>: unknown container <span class="string">"/system.slice/docker.service"</span></span><br></pre></td></tr></table></figure></p>
<p>åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¿®æ”¹kubeletæœåŠ¡çš„é…ç½®æ–‡ä»¶<code>/usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi  /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br></pre></td></tr></table></figure></p>
<p>åœ¨æœ€åä¸€è¡ŒExecStartæœ€åæ·»åŠ <code>--feature-gates SupportPodPidsLimit=false --feature-gates SupportNodePidsLimit=false</code></p>
<p>ä¿®æ”¹å‰</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># Note: This dropin only works with kubeadm and kubelet v1.11+</span><br><span class="line">[Service]</span><br><span class="line">Environment=&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&quot;</span><br><span class="line">Environment=&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;</span><br><span class="line"># This is a file that &quot;kubeadm init&quot; and &quot;kubeadm join&quot; generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically</span><br><span class="line">EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env</span><br><span class="line"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use</span><br><span class="line"># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.</span><br><span class="line">EnvironmentFile=-/etc/sysconfig/kubelet</span><br><span class="line">ExecStart=</span><br><span class="line">ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS</span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹å</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># Note: This dropin only works with kubeadm and kubelet v1.11+</span><br><span class="line">[Service]</span><br><span class="line">Environment=&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&quot;</span><br><span class="line">Environment=&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;</span><br><span class="line"># This is a file that &quot;kubeadm init&quot; and &quot;kubeadm join&quot; generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically</span><br><span class="line">EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env</span><br><span class="line"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use</span><br><span class="line"># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.</span><br><span class="line">EnvironmentFile=-/etc/sysconfig/kubelet</span><br><span class="line">ExecStart=</span><br><span class="line">ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS --feature-gates SupportPodPidsLimit=false --feature-gates SupportNodePidsLimit=false</span><br></pre></td></tr></table></figure>
<p>é‡å¯æ‰€æœ‰èŠ‚ç‚¹</p>
<h5 id="CASE-2"><a href="#CASE-2" class="headerlink" title="CASE 2"></a>CASE 2</h5><p>ç»è¿‡CASE 1æ’é”™ï¼Œä¸»èŠ‚ç‚¹å·²ç»æ²¡æœ‰é—®é¢˜ï¼Œä½†å­èŠ‚ç‚¹ä¾ç„¶æŠ¥é”™</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">May 06 02:17:19 ol75k8sn3 kubelet[740]: E0506 02:17:19.298801     740 summary_sys_containers.go:47] Failed to get system container stats for &quot;/system.slice/docker.service&quot;: failed to get cgroup stats for &quot;/system.slice/docker.service&quot;: failed to get container info for &quot;/system.slice/docker.service&quot;: unknown container &quot;/system.slice/docker.service&quot;</span><br></pre></td></tr></table></figure>
<p>ç»§ç»­åœ¨æ‰€æœ‰å­èŠ‚ç‚¹ä¿®æ”¹kubeletæœåŠ¡çš„é…ç½®æ–‡ä»¶<code>/usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf</code> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi  /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br></pre></td></tr></table></figure>
<p>æ·»åŠ ç¯å¢ƒå‚æ•°<code>Environment=&quot;KUBELET_CGROUP_ARGS=--cgroup-driver=cgroupfs --runtime-cgroups=/systemd/system.slice --kubelet-cgroups=/systemd/system.slice&quot;</code></p>
<p>ä¿®æ”¹å‰<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># Note: This dropin only works with kubeadm and kubelet v1.11+</span><br><span class="line">[Service]</span><br><span class="line">Environment=&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&quot;</span><br><span class="line">Environment=&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;</span><br><span class="line"># This is a file that &quot;kubeadm init&quot; and &quot;kubeadm join&quot; generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically</span><br><span class="line">EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env</span><br><span class="line"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use</span><br><span class="line"># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.</span><br><span class="line">EnvironmentFile=-/etc/sysconfig/kubelet</span><br><span class="line">ExecStart=</span><br><span class="line">ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS --feature-gates SupportPodPidsLimit=false --feature-gates SupportNodePidsLimit=false</span><br></pre></td></tr></table></figure></p>
<p>ä¿®æ”¹å</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># Note: This dropin only works with kubeadm and kubelet v1.11+</span><br><span class="line">[Service]</span><br><span class="line">Environment=&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&quot;</span><br><span class="line">Environment=&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;</span><br><span class="line">Environment=&quot;KUBELET_CGROUP_ARGS=--cgroup-driver=cgroupfs --runtime-cgroups=/systemd/system.slice --kubelet-cgroups=/systemd/system.slice&quot;</span><br><span class="line"># This is a file that &quot;kubeadm init&quot; and &quot;kubeadm join&quot; generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically</span><br><span class="line">EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env</span><br><span class="line"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use</span><br><span class="line"># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.</span><br><span class="line">EnvironmentFile=-/etc/sysconfig/kubelet</span><br><span class="line">ExecStart=</span><br><span class="line">ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS --feature-gates SupportPodPidsLimit=false --feature-gates SupportNodePidsLimit=false</span><br></pre></td></tr></table></figure>
<p>é‡å¯å­èŠ‚ç‚¹çš„kubeletæœåŠ¡</p>
<p>å†æ¬¡æŸ¥çœ‹kubeletçš„logï¼Œç¡®è®¤æ²¡æœ‰Errorä¿¡æ¯</p>
<h4 id="Dashboardéƒ¨ç½²ï¼ˆTBDï¼‰"><a href="#Dashboardéƒ¨ç½²ï¼ˆTBDï¼‰" class="headerlink" title="Dashboardéƒ¨ç½²ï¼ˆTBDï¼‰"></a>Dashboardéƒ¨ç½²ï¼ˆTBDï¼‰</h4><h3 id="é€šè¿‡äºŒè¿›åˆ¶å®‰è£…åŒ…éƒ¨ç½²é›†ç¾¤"><a href="#é€šè¿‡äºŒè¿›åˆ¶å®‰è£…åŒ…éƒ¨ç½²é›†ç¾¤" class="headerlink" title="é€šè¿‡äºŒè¿›åˆ¶å®‰è£…åŒ…éƒ¨ç½²é›†ç¾¤"></a>é€šè¿‡äºŒè¿›åˆ¶å®‰è£…åŒ…éƒ¨ç½²é›†ç¾¤</h3><h3 id="å®‰è£…Kubernetesé›†ç¾¤è¿‡ç¨‹ä¸­å¯èƒ½é‡åˆ°çš„é—®é¢˜-TBD"><a href="#å®‰è£…Kubernetesé›†ç¾¤è¿‡ç¨‹ä¸­å¯èƒ½é‡åˆ°çš„é—®é¢˜-TBD" class="headerlink" title="å®‰è£…Kubernetesé›†ç¾¤è¿‡ç¨‹ä¸­å¯èƒ½é‡åˆ°çš„é—®é¢˜ (TBD)"></a>å®‰è£…Kubernetesé›†ç¾¤è¿‡ç¨‹ä¸­å¯èƒ½é‡åˆ°çš„é—®é¢˜ (TBD)</h3><h4 id="å¦‚ä½•ä¿®æ”¹åœ°å€èŒƒå›´"><a href="#å¦‚ä½•ä¿®æ”¹åœ°å€èŒƒå›´" class="headerlink" title="å¦‚ä½•ä¿®æ”¹åœ°å€èŒƒå›´"></a>å¦‚ä½•ä¿®æ”¹åœ°å€èŒƒå›´</h4><p>k8s ä¸­å¦‚ä½•ä¿®æ”¹ pod-network-cidr åœ°å€èŒƒå›´<br>æ‰“å¼€ä¸‹é¢çš„2ä¸ªé…ç½®ï¼Œå°† 10.244.0.0/16 æ”¹ä¸º 192.168.0.0/16<br>1ï¼‰kubectl -n kube-system edit cm kubeadm-config<br>2ï¼‰vim /etc/kubernetes/manifests/kube-scheduler.yaml<br>é€šè¿‡ kubectl cluster-info dump | grep -m 1 cluster-cidr å‘½ä»¤å¯ä»¥æ£€æŸ¥é…ç½®æ˜¯å¦ç”Ÿæ•ˆ</p>
<h2 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h2><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒmasterèŠ‚ç‚¹ä¸åº”è¯¥å‚ä¸podçš„è°ƒåº¦ï¼Œä½†å¯ä»¥é€šè¿‡è®¾ç½®æ”¹å˜</p>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>è®©masterèŠ‚ç‚¹å‚ä¸podè°ƒåº¦æœ‰å¯èƒ½ä¼šå› ä¸ºmasterèŠ‚ç‚¹èµ„æºä¸è¶³å¯¼è‡´K8Sé›†ç¾¤ä¸ç¨³å®š</li>
</ul>
</blockquote>
<p>kubernetesæ˜¯é€šè¿‡çš„taintï¼ˆæ±¡ç‚¹ï¼‰æ¥å†³å®šè°ƒåº¦è§„åˆ™çš„</p>
<h2 id="å­˜å‚¨å·"><a href="#å­˜å‚¨å·" class="headerlink" title="å­˜å‚¨å·"></a>å­˜å‚¨å·</h2><h2 id="Troubleshooting"><a href="#Troubleshooting" class="headerlink" title="Troubleshooting"></a>Troubleshooting</h2><h3 id="1-å¼ºåˆ¶åˆ é™¤pod"><a href="#1-å¼ºåˆ¶åˆ é™¤pod" class="headerlink" title="1. å¼ºåˆ¶åˆ é™¤pod"></a>1. å¼ºåˆ¶åˆ é™¤pod</h3><p>ä¸€èˆ¬åˆ é™¤podéƒ½æ˜¯é€šè¿‡<code>kubectl delete pod</code>æ¥åˆ çš„<br>æœ‰çš„æ—¶å€™ï¼Œåˆ é™¤podåä¸€ç›´æ˜¯<code>Terminating</code>çŠ¶æ€ï¼Œæ— æ³•ç»§ç»­ï¼Œå¦‚ä¸‹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@labk8sn1 ~]# kubectl get pods --all-namespaces -o wide</span><br><span class="line">NAMESPACE     NAME                                       READY   STATUS        RESTARTS   AGE     IP                NODE       NOMINATED NODE   READINESS GATES</span><br><span class="line">kube-system   coredns-7ff77c879f-s5jc5                   0/1     Terminating   0          38m     192.168.102.80    labk8sn2   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥é€šè¿‡<code>kubectl delete pods &lt;pod&gt; --grace-period=0 --force</code>æ¥å¼ºåˆ¶åˆ é™¤<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pods calico-kube-controllers-789f6df884-dvpk8 --grace-period=0 --force -n kube-system</span><br></pre></td></tr></table></figure></p>
<h3 id="2-é‡ç½®kubernetes"><a href="#2-é‡ç½®kubernetes" class="headerlink" title="2. é‡ç½®kubernetes"></a>2. é‡ç½®kubernetes</h3><p>æœ‰çš„æ—¶å€™å®‰è£…å¤±è´¥ï¼Œæˆ–ç½‘ç»œæ’ä»¶æœ‰é—®é¢˜ï¼Œæˆ–æ¢IPï¼Œæˆ–è€…å…¶ä»–ä¸€äº›åœºæ™¯ï¼Œéœ€è¦é‡æ–°<code>kubeadm init</code>å’Œ<code>kubeadm join</code>ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤é‡ç½®kubenetes<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># é‡ç½®kubeadm</span><br><span class="line"># æ¸…ç©ºiptablesè§„åˆ™</span><br><span class="line"># é‡å¯</span><br><span class="line">kubeadm reset -f</span><br><span class="line">iptables -F &amp;&amp; iptables -t nat -F &amp;&amp; iptables -t mangle -F &amp;&amp; iptables -X</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure></p>
<p>é‡å¯åéœ€è¦åˆ é™¤ä¹‹å‰kubeadmç”Ÿæˆçš„é…ç½®æ–‡ä»¶</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -rf $HOME/.kube</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>é‡ç½®åï¼Œå†æ¬¡<code>kubeadm init</code>æˆ–<code>kubeadm join</code>éƒ½æ— éœ€è”ç½‘</li>
</ul>
</blockquote>
<h3 id="3-ç«¯å£å ç”¨"><a href="#3-ç«¯å£å ç”¨" class="headerlink" title="3. ç«¯å£å ç”¨"></a>3. ç«¯å£å ç”¨</h3><p>é‡ç½®ä¹‹åï¼Œå†æ¬¡<code>kubeadm join</code>ï¼ŒæŠ¥é”™å¦‚ä¸‹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ERROR Port-10250]: Port 10250 is in use</span><br></pre></td></tr></table></figure></p>
<p>ç”¨<code>lsof -i:10250</code>å‘ç°å°±æ˜¯kubeletåœ¨å ç”¨</p>
<p>å†æ¬¡<code>kubeadm reset</code>å¹¶é‡å¯å³å¯</p>
<h3 id="4-åœ¨resetä¹‹åéœ€è¦æ¸…ç†æ—§é…ç½®æ–‡ä»¶"><a href="#4-åœ¨resetä¹‹åéœ€è¦æ¸…ç†æ—§é…ç½®æ–‡ä»¶" class="headerlink" title="4. åœ¨resetä¹‹åéœ€è¦æ¸…ç†æ—§é…ç½®æ–‡ä»¶"></a>4. åœ¨resetä¹‹åéœ€è¦æ¸…ç†æ—§é…ç½®æ–‡ä»¶</h3><p>æŠ¥é”™å¦‚ä¸‹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@labk8sn1 default]# kubectl get nodes</span><br><span class="line">Unable to connect to the server: x509: certificate signed by unknown authority (possibly because of &quot;crypto/rsa: verification error&quot; while trying to verify candidate authority certificate &quot;kubernetes&quot;)</span><br></pre></td></tr></table></figure></p>
<p>è¿™ç§æƒ…å†µä¸€èˆ¬å‡ºç°åœ¨é‡ç½®ä¹‹åï¼Œç”±äºæ²¡æœ‰åˆ é™¤æ—§çš„é…ç½®æ–‡ä»¶å¤¹<code>$HOME/.kube</code>ï¼Œå¯¼è‡´æŠ¥é”™</p>
<p>åˆ é™¤æ—§çš„é…ç½®æ–‡ä»¶å¤¹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -rf $HOME/.kube</span><br></pre></td></tr></table></figure></p>
<p>å†æŒ‰ç…§<code>kubeadm init</code>æç¤ºä¿¡æ¯é‡Œé¢é‡æ–°æ‹·è´ä¸€ä»½æ–°çš„å³å¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure>
<h3 id="5-cgroup-driverä¸åŒ¹é…"><a href="#5-cgroup-driverä¸åŒ¹é…" class="headerlink" title="5. cgroup driverä¸åŒ¹é…"></a>5. cgroup driverä¸åŒ¹é…</h3><p>åœ¨æˆ‘ä»¬<code>kubeadm init</code>æˆ–<code>kubeadm join</code>è¿è¡Œæ—¶ï¼Œä¼šå‘ç°æœ‰å¦‚ä¸‹æç¤ºä¿¡æ¯ï¼Œè¿™ä¸æ˜¯ä¸ªé”™è¯¯ï¼Œåªæ˜¯æŠ¥è­¦<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[WARNING IsDockerSystemdCheck]: detected &quot;cgroupfs&quot; as the Docker cgroup driver. The recommended driver is &quot;systemd&quot;. Please follow the guide at https://kubernetes.io/docs/setup/cri/</span><br><span class="line">error execution phase preflight: [preflight] Some fatal errors occurred:</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>dockerçš„cgroup driverå’ŒK8Sçš„cgroup driverå¿…é¡»ä¸€è‡´</li>
</ul>
</blockquote>
<p>è¿™ä¸ªæŠ¥è­¦ä¿¡æ¯çš„ä¸»è¦åŸå› æ˜¯dockerçš„é»˜è®¤cgroup driveræ˜¯<code>cgroupfs</code>ï¼ŒK8Sä¼šä¾¦æµ‹åˆ°dockerçš„cgroup driverï¼Œå¹¶å°†è‡ªå·±çš„cgroup driverè®¾ç½®ä¸º<code>cgroupfs</code>ï¼›ä½†æç¤ºä¿¡æ¯é‡Œé¢æ¨èç”¨<code>systemd</code></p>
<p>ä½†å°è¯•æ¢ä¸º<code>systemd</code>æ²¡æœ‰æˆåŠŸ</p>
<p><strong>æ³¨æ„ä»¥ä¸‹æ“ä½œæ²¡æœ‰æˆåŠŸ</strong></p>
<p>å°è¯•æŠŠ<code>cgroupfs</code>æ”¹ä¸º<code>systemd</code></p>
<p>ä¿®æ”¹docker</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/docker/daemon.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">  &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class="line">  &quot;log-opts&quot;: &#123;</span><br><span class="line">    &quot;max-size&quot;: &quot;100m&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;storage-driver&quot;: &quot;overlay2&quot;,</span><br><span class="line">  &quot;storage-opts&quot;: [</span><br><span class="line">    &quot;overlay2.override_kernel_check=true&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/systemd/system/docker.service.d</span><br></pre></td></tr></table></figure>
<p>é‡å¯docker</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹K8S</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi  /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹å‚æ•°å¦‚ä¸‹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Environment=&quot;KUBELET_CGROUP_ARGS=--cgroup-driver=systemd --runtime-cgroups=/systemd/system.slice --kubelet-cgroups=/systemd/system.slice&quot;</span><br></pre></td></tr></table></figure></p>
<p>é‡å¯kubelet<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>å¦‚æœéœ€è¦ä¿®æ”¹<code>systemd</code>ï¼Œä»¥ä¸Š<code>systemd</code>æ›¿æ¢ä¸º<code>cgroupfs</code>å³å¯</li>
</ul>
</blockquote>
<h3 id="6-Calico-BIRD-is-not-ready-BGP-not-established"><a href="#6-Calico-BIRD-is-not-ready-BGP-not-established" class="headerlink" title="6. Calico BIRD is not ready: BGP not established"></a>6. Calico BIRD is not ready: BGP not established</h3><p>ç°è±¡è¿˜åŒ…æ‹¬æŸä¸ªcalico-nodeçŠ¶æ€ä¸€ç›´ä¸æ­£å¸¸ï¼Œä¿æŒåœ¨<code>0/1</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kube-system   calico-node-dpln6                          0/1     Running   0          26m</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªé—®é¢˜ä¸»è¦æ˜¯Calicoè‡ªåŠ¨åŒ¹é…çš„ç½‘å¡ä¸å¯¹å¯¼è‡´ï¼ˆæ¯”å¦‚æœåŠ¡å™¨æœ‰å¤šä¸ªç½‘å¡ï¼ŒCalicoè‡ªåŠ¨åŒ¹é…ç¬¬ä¸€ä¸ªç½‘å¡ï¼Œä½†è¿™ä¸ªç½‘å¡å¹¶ä¸å¯¹ï¼‰ï¼Œä¿®æ”¹ä¸‹è½½ä¸‹æ¥çš„é…ç½®æ–‡ä»¶calico.yaml</p>
<p>æœç´¢<code>name: IP</code><br>åœ¨å®ƒä¸Šé¢åŠ å…¥2è¡Œï¼Œå‘ŠçŸ¥ç”¨åˆ°ç½‘å¡æ˜¯å“ªä¸ªï¼Œæ¯”å¦‚ï¼Œæˆ‘æŒ‡å®šçš„æ˜¯ç»‘å®šç½‘å¡bond0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: IP_AUTODETECTION_METHOD</span><br><span class="line">  value: &quot;interface=bond&quot;</span><br></pre></td></tr></table></figure>
<p>ä¿å­˜ååº”ç”¨ä¿®æ”¹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f calico.yaml</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>å®åœ¨è§£å†³ä¸äº†åªèƒ½é‡ç½®ï¼Œé‡ç½®ä¸€èˆ¬èƒ½è§£å†³é—®é¢˜ï¼Œä¹‹å‰æˆ‘å°±æ˜¯ä¸ç®¡æ€ä¹ˆæ”¹éƒ½ä¸è¡Œï¼Œé‡ç½®åè§£å†³</li>
</ul>
</blockquote>
<h3 id="7-Orphaned-pod-found"><a href="#7-Orphaned-pod-found" class="headerlink" title="7. Orphaned pod found"></a>7. Orphaned pod found</h3><p>æŠ¥é”™å¦‚ä¸‹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Jan 21 16:45:44 localhost kubelet[1277]: E0121 16:45:44.079748    1277 kubelet_volumes.go:128] Orphaned pod &quot;86d60ee9-9fae-11e8-8cfc-525400290b20&quot; found, but volume paths are still present on disk. : There were a total of 1 errors similar to this.  Turn up verbosity to see them.</span><br></pre></td></tr></table></figure></p>
<p>åŸå› ä¸»è¦æ—¶åˆ é™¤podåï¼ŒK8Sæ²¡æœ‰æ¸…ç†å¹²å‡€ï¼Œè¿˜èƒ½æ‰¾åˆ°æ®‹ç•™çš„æ–‡ä»¶</p>
<p>æ ¹æ®æç¤ºä¿¡æ¯ï¼Œåˆ°<code>/var/lib/kubelet/pods/</code>ä¸‹å°†äºæŠ¥é”™ä¿¡æ¯å¯¹åº”çš„ä¸€é•¿ä¸²æ•°å­—å‘½åçš„æ–‡ä»¶å¤¹åˆ æ‰å³å¯</p>
<h2 id="åº”ç”¨éƒ¨ç½²"><a href="#åº”ç”¨éƒ¨ç½²" class="headerlink" title="åº”ç”¨éƒ¨ç½²"></a>åº”ç”¨éƒ¨ç½²</h2><h3 id="Node-Red"><a href="#Node-Red" class="headerlink" title="Node-Red"></a>Node-Red</h3><h4 id="dockeréƒ¨ç½²"><a href="#dockeréƒ¨ç½²" class="headerlink" title="dockeréƒ¨ç½²"></a>dockeréƒ¨ç½²</h4><p>æ‹‰å–æœ€æ–°çš„nodered 1.04çš„é•œåƒ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull nodered/node-red:1.0.4</span><br></pre></td></tr></table></figure></p>
<p>è¿è¡Œå®¹å™¨<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -p 1880:1880 -v /data/nodered:/data -e TZ=Asia/Shanghai --name nodered -d nodered/node-red:1.0.4</span><br></pre></td></tr></table></figure></p>
<p><code>-p 1880:1880</code>å°†æœ¬æœºç«¯å£1880æ˜ å°„ä¸ºå®¹å™¨ç«¯å£1880<br><code>-v /data/nodered:/data</code>å°†æœ¬æœºç›®å½•/data/noderedæ˜ å°„ä¸ºå®¹å™¨å†…ç›®å½•/dataï¼Œå®¹å™¨å†…çš„é»˜è®¤ç›®å½•å°±æ˜¯<code>/data</code><br><code>-e TZ=Asia/Shanghai</code>è®¾ç½®æ—¶åŒº<br><code>--name nodered</code>ç”Ÿæˆçš„å®¹å™¨å‘½åä¸ºnodered<br><code>-d nodered/node-red:1.0.4</code>éƒ¨ç½²çš„æœ¬åœ°é•œåƒæ˜¯nodered/node-red:1.0.4</p>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>åœ¨è™šæ‹Ÿæœºä¸Šåˆ›å»ºæœ¬åœ°ç›®å½•æ—¶ï¼Œä¾‹å¦‚æœ¬ä¾‹ä¸­æ˜¯<code>/data/nodered</code>ï¼Œéœ€è¦å°†å…¶è¯»å†™æƒé™è®¾ä¸º<code>777</code>ï¼Œå¦åˆ™æŠ¥é”™</li>
</ul>
</blockquote>
<h4 id="K8Séƒ¨ç½²"><a href="#K8Séƒ¨ç½²" class="headerlink" title="K8Séƒ¨ç½²"></a>K8Séƒ¨ç½²</h4><p>åˆ›å»ºåä¸º<code>deployment_nodered.yml</code>çš„é…ç½®æ–‡ä»¶<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nodered-deployment</span><br><span class="line">  labels:</span><br><span class="line">    app: nodered</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nodered</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nodered</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: nodered/node-red:1.0.4  </span><br><span class="line">        name: nodered</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 1880</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: nodered-volume-01</span><br><span class="line">          mountPath: /data</span><br><span class="line">      volumes:</span><br><span class="line">        - name: nodered-volume-01</span><br><span class="line">          hostPath:</span><br><span class="line">              path: /data/nodered/nodered01</span><br></pre></td></tr></table></figure></p>
<p>èŠ‚ç‚¹ä¸Šæœ¬æœºç›®å½•ä¸º<code>/data/nodered/nodered01</code>ï¼Œèµ‹äºˆ<code>777</code>æƒé™</p>
<p>åˆ›å»º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f deployment_nodered.yml</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡serviceæš´éœ²ç«¯å£</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl expose deployment nodered-deployment --type=NodePort --port=1880 --target-port=1880</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸‹æš´éœ²å‡ºæ¥çš„ç«¯å£æ˜¯30947<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@labk8sn1 ~]# kubectl get svc -o wide</span><br><span class="line">NAME                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE    SELECTOR</span><br><span class="line">kubernetes           ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP          2d3h   &lt;none&gt;</span><br><span class="line">nodered-deployment   NodePort    10.102.77.22   &lt;none&gt;        1880:30947/TCP   12s    app=nodered</span><br></pre></td></tr></table></figure></p>
<p>é€šè¿‡ä»»æ„èŠ‚ç‚¹IPåŠ å¦‚ä¸Šç«¯å£è®¿é—®</p>
<h3 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h3><h3 id="superset"><a href="#superset" class="headerlink" title="superset"></a>superset</h3><p>å®˜æ–¹github <a href="https://github.com/amancevice/docker-superset" target="_blank" rel="noopener">Link</a></p>
<p>è¿è¡Œsuperset<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name superset -itd -p 8088:8088 -v /data/superset/config:/etc/superset -v /data/superset/sqllite:/var/lib/superset amancevice/superset</span><br></pre></td></tr></table></figure></p>
<p><code>-v</code>:æŒ‚è½½ç›®å½•ï¼Œå¯¹äºsupersetæ¥è¯´ï¼Œé…ç½®æ–‡ä»¶ç›®å½•<code>/etc/superset</code>æˆ–è€…<code>/home/superset</code> éƒ½å¯ä»¥ï¼Œåªè¦æ˜ å°„ä¸€ä¸ªå°±è¡Œ;æœ¬ä¾‹ä¸­å°†æœ¬æœºçš„<code>/data/superset</code>æ˜ å°„ä¸ºå®¹å™¨çš„<code>/home/superset</code>ï¼›æ•°æ®æ–‡ä»¶ç›®å½•åœ¨å®¹å™¨çš„<code>/var/lib/superset</code>ä¸‹</p>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li><code>-v</code>å¯ä»¥å¤šæ¬¡ä½¿ç”¨æ¥æŒ‚è½½å¤šä¸ªç›®å½•</li>
<li>æœ¬æœºç›®å½•éœ€è¦777æƒé™</li>
</ul>
</blockquote>
<p>åˆå§‹åŒ–æ•°æ®åº“ï¼Œä¼šæç¤ºåˆ›å»ºadmin user</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it superset superset-init</span><br></pre></td></tr></table></figure>
<p>ä¹‹åå°±å¯ä»¥é€šè¿‡<code>http://IP:8088</code>çš„æ–¹å¼æ¥æ‰“å¼€supersetçš„UI</p>
<p>å®¹å™¨å¦‚æœéœ€è¦ç‰ˆæœ¬å‡çº§ï¼Œè§github</p>
<h2 id="Helm"><a href="#Helm" class="headerlink" title="Helm"></a>Helm</h2><h2 id="ç§æœ‰K8Sé›†ç¾¤åˆ›å»ºLoadBalanceæœåŠ¡ï¼ˆTBDï¼‰"><a href="#ç§æœ‰K8Sé›†ç¾¤åˆ›å»ºLoadBalanceæœåŠ¡ï¼ˆTBDï¼‰" class="headerlink" title="ç§æœ‰K8Sé›†ç¾¤åˆ›å»ºLoadBalanceæœåŠ¡ï¼ˆTBDï¼‰"></a>ç§æœ‰K8Sé›†ç¾¤åˆ›å»ºLoadBalanceæœåŠ¡ï¼ˆTBDï¼‰</h2><p>é€šè¿‡metallbä¸ºç§æœ‰çš„Kebernetesé›†ç¾¤åˆ›å»ºLoad BalanceæœåŠ¡<br>metallb Github <a href="https://github.com/metallb/metallb" target="_blank" rel="noopener">link</a><br>metallbä¼šä»ä½ ç»™å®šçš„IPæ± ä¸­é€‰ä¸€ä¸ªä½œä¸ºserviceçš„external IPç»™åˆ°deployment</p>
<h2 id="é™„ä»¶"><a href="#é™„ä»¶" class="headerlink" title="é™„ä»¶"></a>é™„ä»¶</h2><p><a href="http://docs.kubernetes.org.cn/227.html" target="_blank" rel="noopener">http://docs.kubernetes.org.cn/227.html</a></p>
<h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><p>v1.0ï¼Œ2020.02.15~2020.05.31ï¼Œåˆå§‹ç‰ˆæœ¬</p>

    </div>
  </div>
  
    <div class="copy-right">
      <div class="markdown-body">
        <blockquote>
        
        
          æœ¬æ–‡ä½œè€… : Shen Peng <br>
        
        åŸæ–‡é“¾æ¥ : <a href="">http://yoursite.com/2020/02/15/Kubernetes-K8S/</a><br>
        ç‰ˆæƒå£°æ˜ : æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
        </blockquote>
      </div>
    </div>
  
  
  
    <div class="social-share" style="margin-top: -2rem" data-wechat-qrcode-title="<p>å¾®ä¿¡æ‰«ä¸€æ‰«</p>" data-wechat-qrcode-helper="<p>å¾®ä¿¡å³ä¸Šè§’, æ‰«ä¸€æ‰«åˆ†äº«</p>" data-sites="qzone, qq, weibo, wechat, douban, google, facebook, twitter">
  <span style="color: #6b7487; font-size: 1.4rem;">åˆ†äº«åˆ°: </span>
</div>
<script src="https://cdn.bootcss.com/social-share.js/1.0.16/js/social-share.min.js" async></script>
  

  
    <div id="reward">
  
    <p id="reward-meta">çŸ¥è¯† & æƒ…æ€€ | äºŒè€…å…¼å¾—</p>
  
  <button id="reward-btn">
    
    <span>æŠ•é£Ÿ</span>
  </button>
  <div id="reward-qrcode">
    
      <div class="reward-qrcode--container">
        <img class="qrcode-img" src="/images/wechat.png" alt="å¾®ä¿¡æ‰«ä¸€æ‰«, å‘æˆ‘æŠ•é£Ÿ">
        <p class="qrcode-meta">å¾®ä¿¡æ‰«ä¸€æ‰«, å‘æˆ‘æŠ•é£Ÿ</p>
      </div>
    
      <div class="reward-qrcode--container">
        <img class="qrcode-img" src="/images/alipay.png" alt="æ”¯ä»˜å®æ‰«ä¸€æ‰«, å‘æˆ‘æŠ•é£Ÿ">
        <p class="qrcode-meta">æ”¯ä»˜å®æ‰«ä¸€æ‰«, å‘æˆ‘æŠ•é£Ÿ</p>
      </div>
    
  </div>

</div>

<script>
  (() => {
    let button = document.querySelector('#reward-btn'),
      qrcode = document.querySelector('#reward-qrcode'),
      display = false;
    
    button.addEventListener('click', () => {
      qrcode.style.display = display ? 'none' : 'block'
      display = !display
    }, false)
  })()
</script>
  

  <div class="article-footer">
    <div class="article-meta pull-left">
      <span>
        
          <i class="iconfont icon-06tags"></i>æ ‡ç­¾: 
          
          <span class="span--tag">
            <a href="/tags/kubernetes/">
              #kubernetes
            </a>
          </span>
          
          <span class="span--tag">
            <a href="/tags/docker/">
              #docker
            </a>
          </span>
          
          <span class="span--tag">
            <a href="/tags/k8s/">
              #k8s
            </a>
          </span>
          
          <span class="span--tag">
            <a href="/tags/linux/">
              #linux
            </a>
          </span>
          
        
      </span>
    </div>
    <div class="article-meta pull-right">
    </div>
  </div>
</div>


  <aside id="sidebar">
    <p id="sidebar-header"></p>
    <ol id="sidebar-toc"></ol>
  </aside>
  <script async>setTimeout(generateToc, 10);</script>


  <nav class="post-navigation">
    
      <div class="nav-pre">
        <i class="iconfont icon-prev"></i>
        ä¸Šä¸€ç¯‡:
        <a href="/2020/02/06/å¸¸ç”¨Linuxå‘½ä»¤å¯¹æ¯”/" target="_self">å¸¸ç”¨Linuxå‘½ä»¤å¯¹æ¯”</a>
      </div>
    
    
      <div class="nav-next">
        ä¸‹ä¸€ç¯‡:
        <a href="/2020/03/24/LVMç®¡ç†/" target="_self">LVMç®¡ç†</a>
        <i class="iconfont icon-next"></i>
      </div>
    
  </nav>

  
    <a href="#comment" class="comment-anchor"></a>
<div class="comment-title"><i class="iconfont icon-footprint"></i> ç•™ä¸‹è¶³è¿¹ <i class="iconfont icon-footprint"></i></div>
<div id="vcomments"></div>

<script defer>
  if( true ) {
    let path = getRealPath()
    new Valine({
      el: "#vcomments",
      appId: "3OKDIg4e0wo2F4MdSnk6pURw-gzGzoHsz",
      appKey: "HL7IxJ3hMAqxfnzCoBXPPdqL",
      notify: false,
      verify: false,
      avatar: "robohash",
      placeholder: "æ­£ç¡®å¡«å†™é‚®ç®±, æ‰èƒ½åŠæ—¶æ”¶åˆ°å›å¤å“¦â™ª(^âˆ‡^*)",
      path
    });
  }
</script>
   

  
    <script defer>
const valineAPI = (() => {
  try {
    AV.init("3OKDIg4e0wo2F4MdSnk6pURw-gzGzoHsz", "HL7IxJ3hMAqxfnzCoBXPPdqL");
  } catch(error) {}
  const isExist = (identity) => {
    identity = identity || getRealPath();
    let query = new AV.Query('Timer');
    return new Promise((resolve, reject) => {
      query.equalTo("identity", identity);
      query.find().then(results => {
        resolve(results.length > 0);
      }, error => reject(error));
    })
  }

  const _get = (identity) => {
    let query = null;
    if(identity && identity instanceof Array){
      let querys = [];
      for(let i = 0; i < identity.length; ++i) {
        querys[i] = new AV.Query('Timer');
        querys[i].equalTo('identity', identity[i]);
      }
      query = AV.Query.or.apply(null ,querys);
    } else {
      identity = identity || getRealPath();
      query = new AV.Query("Timer");
      query.equalTo("identity", identity);
    }

    return new Promise((resolve, reject) => {
      query.find()
      .then(results => resolve(results))
      .catch(error => reject(error))
    })
  }

  const create = (identity) => {
    identity = identity || getRealPath();
    return new Promise((resolve, reject) => {
      let Todo = AV.Object.extend('Timer');
      let todo = new Todo();
      todo.set("times", 1);
      todo.set("identity", identity);
      todo.save().then(res => resolve(true), error => reject(error));
    })
  }

  const update = (identity) => {
    identity = identity || getRealPath();
    return new Promise((resolve, reject) => {
      let query = new AV.Query('Timer');
      query.equalTo("identity", identity);
      query.find().then(todos => {
        todos.forEach(todo => {
          todo.set("times", todo.attributes.times + 1);
        });
        return AV.Object.saveAll(todos);
      }).then(todos => resolve(true), error => reject(error));
    })
  }

  return {
    isExist,
    _get,
    update,
    create
  }
})()

const calcAndWriteTimes = () => {
  let isPost = true;

  let timerAllDOM = document.querySelectorAll(".article-timer");

  if(isPost) {
    let identity = timerAllDOM[0].getAttribute("data-identity");
    valineAPI.isExist(identity)
    .then(exist => {
      if(exist) {
        return valineAPI.update(identity);
      }
      return new Promise(resolve => resolve(true));
    })
    .then( succuess => valineAPI._get(identity))
    .then( result => timerAllDOM[0].innerText = result[0].attributes.times)
    .catch(error => console.log(error.message))
    return ;
  }

  let timerDOMCache = {};

  for(let timerDOM of timerAllDOM) {
    let identity = timerDOM.getAttribute("data-identity");
    if(timerDOMCache.hasOwnProperty(identity)){
      timerDOMCache[identity].dom.push(timerDOM);
    }else{
      timerDOMCache[identity] = {
        dom: [timerDOM],
        times: undefined
      };
    }
  }

  let identities = Object.keys(timerDOMCache);
  valineAPI._get(identities).then(results => {
    for(let result of results) {
      let {identity, times} = result.attributes;
      timerDOMCache[identity].times = times;
      timerDOMCache[identity].dom.map(item => item.innerText = times);
    }
    for(let identity of identities) {
      if(timerDOMCache[identity].times){
        continue;
      }
      timerDOMCache[identity].dom.map(item => item.innerText = 1);
      valineAPI.create(identity);
    }
  }).catch(error => console.log(error.message))
}

if(true){
  calcAndWriteTimes();
}
</script>
   

</div>


      <footer>
  <p class="site-info">
    åšå®¢å·²èŒèŒå“’è¿è¡Œ<span id="time-to-now"></span><span class="my-face">(â—'â—¡'â—)ï¾‰â™¥</span>
    <br>
    Theme - <a href="https://github.com/dongyuanxin/theme-bmw">BMW</a> | Made With ğŸ’— | Powered by <a href="https://godbmw.com/">GodBMW</a>
    <br>
    
  </p>
</footer>



<script>
const timeToNowDOM = document.querySelector("#time-to-now");
const startTimestamp = new Date(2018, 1, 10).getTime();

const updateTimeStr = () => {
  let offset = parseInt(
      (new Date().getTime() - startTimestamp) / 1000,
      10
    ),
    day = Math.floor(offset / 86400),
    hour = Math.floor((offset % 86400) / 3600),
    minute = Math.floor(((offset % 86400) % 3600) / 60),
    second = Math.floor(((offset % 86400) % 3600) % 60);
  timeToNowDOM.innerHTML =
    day + "å¤©" + hour + "å°æ—¶" + minute + "åˆ†é’Ÿ" + second + "ç§’";
  setTimeout(updateTimeStr, 500);
}

setTimeout(updateTimeStr, 500);
</script>


      <div class="back-to-top hidden">
  <span>
    <i class="iconfont icon-60"></i><span></span>%
  </span>
</div>

<script>
const updateIconToTop = percent => {
  let dom = document.querySelector(".back-to-top span span");
  dom.innerText = percent;
  if(percent < 1) {
    document.querySelector(".back-to-top").className = "back-to-top hidden";
  } else {
    document.querySelector(".back-to-top").className = "back-to-top";
  }
}

const handleScoll = () => {
  let isRunning = false;
  return () => {
    if (isRunning) return;
    isRunning = true;
    window.requestAnimationFrame(timestamp => {
      let scrollTop =
          document.documentElement.scrollTop || document.body.scrollTop,
        scrollHeight =
          document.documentElement.scrollHeight ||
          document.body.scrollHeight,
        clientHeight =
          document.documentElement.clientHeight ||
          document.body.clientHeight;
      isRunning = false;
      if (scrollTop <= 1) {
        updateIconToTop(0);
        return;
      }
      if (scrollTop + clientHeight >= scrollHeight) {
        updateIconToTop(100);
      } else {
        updateIconToTop(parseInt(
          100 * scrollTop / (scrollHeight - clientHeight),
          10
        ));
      }
    });
  };
}

const backToTop = () => {
  let scrollTop =
      document.documentElement.scrollTop || document.body.scrollTop,
    delay = 10,
    time = 200;
  if (scrollTop <= 20) {
    document.documentElement.scrollTop = 0;
    document.body.scrollTop = 0;
    return;
  }
  let step = Math.ceil(scrollTop * delay / time);
  let timer = setInterval(() => {
    scrollTop =
      document.documentElement.scrollTop || document.body.scrollTop;
    if (scrollTop - step <= 0) {
      document.documentElement.scrollTop = 0;
      document.body.scrollTop = 0;
      clearInterval(timer);
    } else {
      document.documentElement.scrollTop = scrollTop - step;
      document.body.scrollTop = scrollTop - step;
    }
  }, delay);
}

document.addEventListener("scroll", handleScoll(), false);

document.querySelector(".back-to-top").addEventListener("click", backToTop, false);

</script>

    </div>

    
      <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<script>
  (() => {
    const mathjaxConfig = {
      showProcessingMessages: false, //å…³é—­jsåŠ è½½è¿‡ç¨‹ä¿¡æ¯
      messageStyle: "none", //ä¸æ˜¾ç¤ºä¿¡æ¯
      jax: ["input/TeX", "output/HTML-CSS"],
      tex2jax: {
        inlineMath: [["$", "$"], ["\\(", "\\)"]], //è¡Œå†…å…¬å¼é€‰æ‹©ç¬¦
        displayMath: [["$$", "$$"], ["\\[", "\\]"]], //æ®µå†…å…¬å¼é€‰æ‹©ç¬¦
        skipTags: ["script", "noscript", "style", "textarea", "pre", "code", "a"] //é¿å¼€æŸäº›æ ‡ç­¾
      },
      "HTML-CSS": {
        availableFonts: ["STIX", "TeX"], //å¯é€‰å­—ä½“
        showMathMenu: false //å…³é—­å³å‡»èœå•æ˜¾ç¤º
      }
    }

    let mathjaxInterval = setInterval(() => {
      if(!window.MathJax){
        return;
      }
      window.MathJax.Hub.Config(mathjaxConfig)
      window.MathJax.Hub.Queue(["Typeset", MathJax.Hub, document.getElementById('app')])

      clearInterval(mathjaxInterval)
    }, 10)    
  })()
</script>
    

    <script src="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script>
<script async>
  let fancyTimer = setInterval(function(){
    if(!window.$){
      return;
    }
    $(document).ready(function() {
      $(".post img").each(function () {
        if($(this).parent().get(0).tagName.toLowerCase() === "a") {
          return;
        }
        // $(this).attr("data-fancybox", "gallery"); // if you add 'data-fancybox', img will display after showed
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "gallery");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      });
      
      clearInterval(fancyTimer);
    });
  }, 10);
</script>

    
  </body>

</html>
